<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>席替えくん</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .backface-hidden { backface-visibility: hidden; }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
    </style>
</head>
<body>
    <div id="root">
        <div style="padding: 20px; text-align: center;">ツールを起動しています...（30秒以上かかる場合は再読み込みしてください）</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // アイコンを安全に表示するための部品
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const INITIAL_STUDENTS = `1, 佐藤 健, 男\n2, 鈴木 愛, 女\n3, 高橋 翔, 男\n4, 田中 美咲, 女\n5, 伊藤 翼, 男\n6, 渡辺 結衣, 女\n7, 山本 蓮, 男\n8, 中村 陽菜, 女\n9, 小林 湊, 男\n10, 加藤 葵, 女`;

        function App() {
            const [mode, setMode] = useState('teacher');
            const [students, setStudents] = useState([]);
            const [rows, setRows] = useState(8);
            const [cols, setCols] = useState(6);
            const [seats, setSeats] = useState([]);
            const [revealState, setRevealState] = useState({});
            const [isShuffling, setIsShuffling] = useState(false);

            useEffect(() => {
                const list = INITIAL_STUDENTS.trim().split('\n').map((line, i) => {
                    const p = line.split(/[,\t]/).map(s => s.trim());
                    return { id: `s-${i}`, number: p[0], name: p[1], gender: (p[2] && p[2].includes('女')) ? 'F' : 'M' };
                });
                setStudents(list);
                setSeats(new Array(rows * cols).fill(null).map((_, i) => list[i]?.id ?? null));
            }, []);

            const shuffle = () => {
                setIsShuffling(true);
                setTimeout(() => {
                    setSeats(prev => [...prev].sort(() => Math.random() - 0.5));
                    setRevealState({});
                    setIsShuffling(false);
                }, 1500);
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white p-4 shadow flex justify-between items-center">
                        <h1 className="font-bold flex items-center gap-2">
                            <Icon name="settings" /> 座席替えツール
                        </h1>
                        <button onClick={() => setMode(mode==='teacher'?'student':'teacher')} className="bg-teal-600 text-white px-4 py-2 rounded font-bold">
                            {mode==='teacher' ? '生徒画面へ' : '設定へ戻る'}
                        </button>
                    </header>

                    <main className="p-6 flex flex-col items-center">
                        <div className="w-full max-w-4xl bg-[#1a472a] h-10 rounded border-b-8 border-[#5d4037] mb-8 flex items-center justify-center text-white/20 tracking-widest text-xs">BLACKBOARD</div>
                        
                        <div className="grid gap-2 w-full max-w-5xl" style={{ gridTemplateColumns: `repeat(${cols}, 1fr)` }}>
                            {seats.map((sid, i) => {
                                const s = students.find(x => x.id === sid);
                                const rev = revealState[i] || mode === 'teacher';
                                return (
                                    <div key={i} onClick={() => setRevealState(p=>({...p, [i]:!p[i]}))} className="aspect-[4/3] perspective-1000 cursor-pointer">
                                        <div className={`w-full h-full transition-all duration-500 rounded shadow-sm border ${rev ? (s?.gender==='M'?'bg-blue-100':'bg-pink-100') : 'bg-[#f0e6d2]'}`} style={{ transform: rev ? 'rotateY(180deg)' : 'rotateY(0deg)', transformStyle: 'preserve-3d' }}>
                                            <div className="absolute inset-0 flex flex-col items-center justify-center backface-hidden">
                                                {rev && s ? (
                                                    <>
                                                        <span className="text-[10px] text-gray-500">{s.number}</span>
                                                        <span className="font-bold">{s.name}</span>
                                                    </>
                                                ) : (
                                                    <span className="text-xl font-bold text-[#8d6e63] opacity-20">{s?.number}</span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {mode === 'student' && (
                            <div className="fixed bottom-8 flex gap-4">
                                <button onClick={shuffle} className="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                    <Icon name="shuffle" /> シャッフル
                                </button>
                                <button onClick={() => { const ns={}; seats.forEach((_,i)=>ns[i]=true); setRevealState(ns); }} className="bg-green-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">
                                    一斉公開
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
