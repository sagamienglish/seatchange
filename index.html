<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>席替えアプリ</title>
    
    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (アイコン用) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- html2canvas & jsPDF (保存用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* 3Dカード回転エフェクト用 */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* スクロールバー非表示 (見た目スッキリ用) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 文字省略 */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* 印刷設定 */
        @media print {
            @page { size: landscape; margin: 5mm; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            .print\:bg-white { background-color: white !important; }
            .print\:text-black { color: black !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:ring-0 { box-shadow: none !important; }
            body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <!-- アプリのルート要素 -->
    <div id="app" class="h-full w-full flex flex-col md:flex-row overflow-hidden">
        <!-- ここにJSでコンテンツを描画します -->
    </div>

    <!-- モーダル (初期状態は非表示) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal()">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <!-- モーダルの中身はJSで動的に書き換えます -->
        </div>
    </div>

    <script>
        // --- 初期データ ---
        const INITIAL_STUDENTS_TEXT = `1, 佐藤 健, 男
2, 鈴木 愛, 女
3, 高橋 翔, 男
4, 田中 美咲, 女
5, 伊藤 翼, 男
6, 渡辺 結衣, 女
7, 山本 蓮, 男
8, 中村 陽菜, 女
9, 小林 湊, 男
10, 加藤 葵, 女
11, 吉田 樹, 男
12, 山田 凛, 女
13, 佐々木 陸, 男
14, 山口 澪, 女
15, 松本 蒼, 男
16, 井上 紬, 女
17, 木村 大和, 男
18, 林 杏奈, 女
19, 斎藤 悠真, 男
20, 清水 桜, 女
21, 山崎 瑛太, 男
22, 池田 楓, 女
23, 橋本 朝陽, 男
24, 阿部 菫, 女
25, 宮本 琉生, 男
26, 石川 陽菜, 女
27, 中川 湊斗, 男
28, 野口 結菜, 女
29, 酒井 大翔, 男
30, 村上 莉子, 女
31, 小川 悠人, 男
32, 長谷川 咲良, 女
33, 岡田 陽向, 男
34, 藤田 結衣, 女
35, 後藤 陸, 男
36, 近藤 陽菜, 女
37, 石井 湊, 男
38, 小島 葵, 女
39, 遠藤 樹, 男
40, 青木 凛, 女
41, 藤井 陸, 男
42, 西村 澪, 女
43, 安藤 蒼, 男
44, 辻 紬, 女
45, 山下 大和, 男
46, 岡本 杏奈, 女
47, 森本 悠真, 男
48, 今井 桜, 女`;

        // --- 状態管理 (ReactのState相当) ---
        const state = {
            mode: 'teacher', // 'teacher' | 'student'
            students: [],
            rows: 8,
            cols: 6,
            seats: [], // index -> studentId
            lockedSeats: {}, // index -> boolean
            seatAttributes: {}, // index -> 'M' | 'F' | 'EMPTY' | null
            importText: INITIAL_STUDENTS_TEXT,
            importUrl: '',
            revealState: {},
            blackboardPosition: 'top',
            isShuffling: false,
            activeTool: 'CURSOR', // 'CURSOR', 'EMPTY', 'M', 'F', 'SWAP'
            swapSourceIndex: null, // 入れ替え元のインデックス
            editingSeatIndex: null,
            searchQuery: '',
            showSaveMenu: false,
            importError: '',
            isRosterOpen: true, // デフォルトで開く
            isSoundEnabled: true
        };

        // --- Web Audio API (音生成) ---
        let audioCtx = null;

        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext && !audioCtx) {
                audioCtx = new AudioContext();
            }
        }

        function playTone(freq, type, duration, startTime = 0, vol = 0.1) {
            if (!audioCtx || !state.isSoundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime + startTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + startTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(audioCtx.currentTime + startTime);
            osc.stop(audioCtx.currentTime + startTime + duration);
        }

        function playFlip() {
            initAudio();
            const freq = 1000 + Math.random() * 200; 
            playTone(freq, 'sine', 0.1, 0, 0.08);
        }

        function playDrumroll() {
            initAudio();
            if (!audioCtx || !state.isSoundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const count = 12;
            for (let i = 0; i < count; i++) {
                playTone(150 + (i * 25), 'triangle', 0.1, i * 0.10, 0.15);
            }
        }

        function playTada() {
            initAudio();
            if (!audioCtx || !state.isSoundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const notes = [523.25, 659.25, 783.99, 987.77, 1174.66]; 
            notes.forEach((freq, i) => {
                playTone(freq, 'triangle', 1.8, i * 0.06, 0.15);
                playTone(freq * 2, 'sine', 1.2, i * 0.06, 0.05);
            });
        }

        // --- ロジック関数 ---

        function parseStudents(text) {
            const lines = text.trim().split('\n');
            state.students = lines.map((line, i) => {
                const parts = line.split(/[,\t]/).map(p => p.trim()).filter(p => p);
                let number = i + 1;
                let name = `生徒${i+1}`;
                let gender = 'M';

                if (parts.length >= 3) {
                    if (!isNaN(parseInt(parts[0]))) {
                        number = parseInt(parts[0]);
                        name = parts[1];
                        gender = (parts[2].includes('女') || parts[2].toLowerCase().includes('f')) ? 'F' : 'M';
                    } else {
                        name = parts[0];
                        gender = (parts[1].includes('女') || parts[1].toLowerCase().includes('f')) ? 'F' : 'M';
                    }
                } else if (parts.length === 2) {
                    if (!isNaN(parseInt(parts[0]))) {
                        number = parseInt(parts[0]);
                        name = parts[1];
                    } else {
                        name = parts[0];
                        gender = (parts[1].includes('女') || parts[1].toLowerCase().includes('f')) ? 'F' : 'M';
                    }
                } else if (parts.length === 1) {
                    name = parts[0];
                }
                return { id: `s-${i}`, number, name, gender };
            });
        }

        function initSeats() {
            const newSize = state.rows * state.cols;
            const newSeats = new Array(newSize).fill(null);
            for (let i = 0; i < Math.min(state.seats.length, newSize); i++) {
                newSeats[i] = state.seats[i];
            }
            state.seats = newSeats;

            const resizeObj = (prev) => {
                const next = {};
                Object.keys(prev).forEach(key => {
                    if (parseInt(key) < newSize) next[key] = prev[key];
                });
                return next;
            };
            state.lockedSeats = resizeObj(state.lockedSeats);
            state.seatAttributes = resizeObj(state.seatAttributes);
            render();
        }

        async function handleUrlImport() {
            state.importError = '';
            if (!state.importUrl) return;
            let csvUrl = state.importUrl;
            const match = state.importUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match && match[1]) {
                csvUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv`;
            } else {
                state.importError = '有効なGoogleスプレッドシートのURLではありません。';
                render();
                return;
            }
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('アクセスできませんでした。');
                const text = await response.text();
                state.importText = text;
                parseStudents(text);
                state.importUrl = '';
                // 名簿更新後は閉じない（確認のため）
                initSeats(); 
            } catch (e) {
                console.error(e);
                state.importError = '読み込みに失敗しました。「リンクを知っている全員」に公開してください。';
                render();
            }
        }

        function shuffleSeatsLogic() {
            let newSeats = [...state.seats];
            const attributeIndices = { M: [], F: [], EMPTY: [], NONE: [] };
            const lockedStudentIds = new Set();

            for (let i = 0; i < newSeats.length; i++) {
                if (state.lockedSeats[i] && newSeats[i]) {
                    lockedStudentIds.add(newSeats[i]);
                } else {
                    newSeats[i] = null;
                    const attr = state.seatAttributes[i];
                    if (attr === 'EMPTY') attributeIndices.EMPTY.push(i);
                    else if (attr === 'M') attributeIndices.M.push(i);
                    else if (attr === 'F') attributeIndices.F.push(i);
                    else attributeIndices.NONE.push(i);
                }
            }

            let pool = state.students.filter(s => !lockedStudentIds.has(s.id));
            let boys = pool.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
            let girls = pool.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);

            attributeIndices.M.forEach(idx => { if (boys.length > 0) newSeats[idx] = boys.pop().id; });
            attributeIndices.F.forEach(idx => { if (girls.length > 0) newSeats[idx] = girls.pop().id; });
            
            let remaining = [...boys, ...girls].sort(() => Math.random() - 0.5);
            attributeIndices.NONE.forEach(idx => { if (remaining.length > 0) newSeats[idx] = remaining.pop().id; });

            state.seats = newSeats;
            state.revealState = {};
            render();
        }

        function shuffleSeatsWithAnimation() {
            state.isShuffling = true;
            playDrumroll();
            render();
            setTimeout(() => {
                shuffleSeatsLogic();
                state.isShuffling = false;
                playTada();
                render();
            }, 1500);
        }

        function getStudent(id) {
            return state.students.find(s => s.id === id);
        }

        // --- イベントハンドラ (グローバル公開) ---

        window.setMode = (mode) => { state.mode = mode; render(); };
        window.toggleSound = () => { state.isSoundEnabled = !state.isSoundEnabled; render(); };
        window.toggleSaveMenu = () => { state.showSaveMenu = !state.showSaveMenu; render(); };
        window.setActiveTool = (tool) => { 
            state.activeTool = tool; 
            state.swapSourceIndex = null; // ツール変更時に選択解除
            render(); 
        };
        window.toggleRoster = () => { state.isRosterOpen = !state.isRosterOpen; render(); };
        window.updateImportUrl = (val) => { state.importUrl = val; render(); };
        window.updateImportText = (val) => { state.importText = val; }; 
        window.runImport = () => { parseStudents(state.importText); initSeats(); };
        window.runUrlImport = () => handleUrlImport();
        
        window.updateRows = (val) => { 
            let v = parseInt(val);
            if (isNaN(v) || v < 1) v = 1;
            if (v > 20) v = 20; 
            state.rows = v; 
            initSeats(); 
        };
        window.updateCols = (val) => { 
            let v = parseInt(val);
            if (isNaN(v) || v < 1) v = 1;
            if (v > 12) v = 12; 
            state.cols = v; 
            initSeats(); 
        };
        
        window.toggleBlackboard = () => { state.blackboardPosition = state.blackboardPosition === 'top' ? 'bottom' : 'top'; render(); };
        
        window.clearSeats = () => {
            // ロックされていない席の生徒IDを削除
            state.seats = state.seats.map((studentId, i) => state.lockedSeats[i] ? studentId : null);
            state.revealState = {};
            render();
        };

        window.handleSeatClick = (index) => {
            if (state.activeTool === 'CURSOR') {
                openSeatModal(index);
            } else if (state.activeTool === 'EMPTY') {
                if (state.seatAttributes[index] === 'EMPTY') {
                    state.seatAttributes[index] = null;
                } else {
                    state.seatAttributes[index] = 'EMPTY';
                    state.seats[index] = null;
                    state.lockedSeats[index] = false;
                }
                render();
            } else if (state.activeTool === 'M') {
                state.seatAttributes[index] = state.seatAttributes[index] === 'M' ? null : 'M';
                state.lockedSeats[index] = false;
                render();
            } else if (state.activeTool === 'F') {
                state.seatAttributes[index] = state.seatAttributes[index] === 'F' ? null : 'F';
                state.lockedSeats[index] = false;
                render();
            } else if (state.activeTool === 'SWAP') {
                if (state.swapSourceIndex === null) {
                    state.swapSourceIndex = index;
                } else {
                    // 入れ替え処理
                    const sourceIdx = state.swapSourceIndex;
                    const targetIdx = index;
                    const temp = state.seats[sourceIdx];
                    state.seats[sourceIdx] = state.seats[targetIdx];
                    state.seats[targetIdx] = temp;
                    state.swapSourceIndex = null;
                }
                render();
            }
        };

        window.studentToggleCard = (index) => {
            if (state.isShuffling) return;
            playFlip();
            state.revealState[index] = !state.revealState[index];
            render();
        };

        window.revealAll = () => {
            playTada();
            const newState = {};
            state.seats.forEach((_, i) => newState[i] = true);
            state.revealState = newState;
            render();
        };

        window.drumRollReveal = () => {
            playDrumroll();
            state.revealState = {};
            render();
            const unrevealedIndices = state.seats.map((_, i) => i).sort(() => Math.random() - 0.5);
            unrevealedIndices.forEach((index, i) => {
                setTimeout(() => {
                    state.revealState[index] = true;
                    playFlip();
                    render(); 
                }, i * 300 + 1000);
            });
        };

        window.hideAll = () => {
            state.revealState = {};
            render();
        }

        // モーダル関連
        function openSeatModal(index) {
            state.editingSeatIndex = index;
            state.searchQuery = '';
            renderModal();
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.closeModal = () => {
            state.editingSeatIndex = null;
            document.getElementById('modal-overlay').classList.add('hidden');
        };

        window.updateSearchQuery = (val) => {
            state.searchQuery = val;
            renderModal();
        };

        window.editSeat = (action, payload) => {
            const index = state.editingSeatIndex;
            if (index === null) return;

            if (action === 'SET_EMPTY') {
                state.seats[index] = null;
                state.lockedSeats[index] = false;
                state.seatAttributes[index] = 'EMPTY';
            } else if (action === 'SET_ATTRIBUTE') {
                state.seatAttributes[index] = payload;
                state.lockedSeats[index] = false;
                if (payload) state.seats[index] = null;
            } else if (action === 'SET_STUDENT') {
                const currentSeatOfStudent = state.seats.indexOf(payload);
                if (currentSeatOfStudent !== -1) {
                    state.seats[currentSeatOfStudent] = null;
                    state.lockedSeats[currentSeatOfStudent] = false;
                }
                state.seats[index] = payload;
                state.lockedSeats[index] = true;
                state.seatAttributes[index] = null;
            }
            closeModal();
            render();
        };

        // 保存機能
        window.prepareAndCapture = async (type) => {
            state.showSaveMenu = false;
            render(); 
            
            const captureElement = document.getElementById('capture-container');
            if (!captureElement) return;

            try {
                if (window.html2canvas) {
                    const canvas = await window.html2canvas(captureElement, {
                        scale: 3,
                        backgroundColor: '#ffffff',
                        logging: false,
                        useCORS: true,
                        windowWidth: 1600, 
                        onclone: (clonedDoc) => {
                            const el = clonedDoc.getElementById('capture-container');
                            if (el) {
                                el.style.width = '1400px';
                                el.style.height = 'auto';
                                el.style.minHeight = '1000px';
                                el.style.padding = '40px';
                                el.style.overflow = 'visible';
                                el.style.position = 'static';
                                
                                const main = clonedDoc.querySelector('main');
                                if(main) {
                                    main.style.overflow = 'visible';
                                    main.style.height = 'auto';
                                }
                                
                                const grid = el.querySelector('.seat-grid');
                                if (grid) {
                                    grid.style.height = 'auto';
                                    grid.style.display = 'grid';
                                    grid.style.gap = '16px';
                                    grid.style.gridTemplateColumns = `repeat(${state.cols}, 1fr)`;
                                    grid.style.gridTemplateRows = `repeat(${state.rows}, minmax(120px, auto))`;
                                }
                                
                                const cells = el.querySelectorAll('.seat-cell');
                                cells.forEach(cell => {
                                    cell.style.height = 'auto';
                                    cell.style.minHeight = '120px';
                                    cell.style.aspectRatio = 'auto';
                                    cell.style.display = 'flex';
                                    cell.style.flexDirection = 'column';
                                    cell.style.justifyContent = 'center';
                                    
                                    const nameDiv = cell.querySelector('.student-name');
                                    if (nameDiv) {
                                        nameDiv.style.fontSize = '24px';
                                        nameDiv.style.lineHeight = '1.2';
                                        nameDiv.style.whiteSpace = 'normal';
                                        nameDiv.style.overflow = 'visible';
                                        nameDiv.classList.remove('line-clamp-2');
                                    }
                                });
                            }
                        }
                    });

                    if (type === 'png') {
                        const fileName = `座席表.png`;
                        canvas.toBlob(async (blob) => {
                            if (blob && navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/png' })] })) {
                                try { await navigator.share({ files: [new File([blob], fileName, { type: 'image/png' })], title: '座席表' }); return; } catch (err) {}
                            }
                            const link = document.createElement('a');
                            link.download = fileName;
                            link.href = canvas.toDataURL();
                            link.click();
                        });
                    } else if (type === 'pdf' && window.jspdf) {
                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({ orientation: 'landscape' });
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const ratio = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height) * 0.9;
                        pdf.addImage(imgData, 'PNG', (pdfWidth - imgProps.width * ratio)/2, (pdfHeight - imgProps.height * ratio)/2, imgProps.width * ratio, imgProps.height * ratio);
                        pdf.save('座席表.pdf');
                    }
                }
            } catch (e) {
                console.error(e);
                alert("保存に失敗しました。");
            }
        };


        // --- レンダリング ---
        function render() {
            const app = document.getElementById('app');
            let content = '';

            if (state.mode === 'teacher') {
                content = renderTeacherMode();
            } else {
                content = renderStudentMode();
            }
            
            app.innerHTML = content;
            lucide.createIcons();
        }

        function renderTeacherMode() {
            const displayIndices = Array.from({ length: state.seats.length }, (_, i) => i);
            if (state.blackboardPosition === 'bottom') displayIndices.reverse();

            // サイドバー
            const sidebar = `
            <aside class="w-full md:w-64 bg-white border-b md:border-r md:border-b-0 p-2 overflow-y-auto print:hidden shadow-inner flex flex-col gap-2 shrink-0 h-auto md:h-full max-h-[40vh] md:max-h-full z-20">
                <div class="flex justify-between items-center">
                    <h1 class="font-bold flex items-center text-gray-700 text-sm md:text-base"><i data-lucide="settings" class="mr-1 w-4 h-4"></i> <span class="hidden md:inline">設定</span><span class="md:hidden">設定</span></h1>
                    <div class="flex gap-1 md:hidden">
                        <button onclick="shuffleSeatsWithAnimation()" ${state.isShuffling ? 'disabled' : ''} class="p-1.5 bg-indigo-600 text-white rounded disabled:opacity-50"><i data-lucide="shuffle" class="w-3.5 h-3.5"></i></button>
                        <button onclick="toggleSaveMenu()" class="p-1.5 bg-gray-200 text-gray-700 rounded relative">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            ${state.showSaveMenu ? renderSaveMenu() : ''}
                        </button>
                        <button onclick="setMode('student')" class="p-1.5 bg-teal-600 text-white rounded"><i data-lucide="monitor" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>

                <div class="hidden md:flex flex-col gap-2">
                    <button onclick="shuffleSeatsWithAnimation()" ${state.isShuffling ? 'disabled' : ''} class="flex items-center justify-center gap-1 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white px-2 py-1.5 rounded font-bold shadow-sm text-xs"><i data-lucide="shuffle" class="w-3.5 h-3.5"></i> 席替え実行</button>
                    <button onclick="clearSeats()" class="flex items-center justify-center gap-1 bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1.5 rounded font-bold shadow-sm text-xs"><i data-lucide="eraser" class="w-3.5 h-3.5"></i> クリア</button>
                    <div class="flex gap-1">
                        <button onclick="window.print()" class="flex-1 flex items-center justify-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1.5 rounded font-bold text-xs"><i data-lucide="printer" class="w-3 h-3"></i> 印刷</button>
                        <div class="relative flex-1">
                            <button onclick="toggleSaveMenu()" class="w-full flex items-center justify-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1.5 rounded font-bold text-xs"><i data-lucide="download" class="w-3 h-3"></i> 保存</button>
                            ${state.showSaveMenu ? renderSaveMenu() : ''}
                        </div>
                    </div>
                    <button onclick="setMode('student')" class="flex items-center justify-center gap-1 bg-teal-600 hover:bg-teal-700 text-white px-2 py-1.5 rounded font-bold shadow-sm text-xs"><i data-lucide="monitor" class="w-3.5 h-3.5"></i> 生徒モード</button>
                </div>

                <section class="bg-indigo-50 p-2 rounded border border-indigo-100 text-xs">
                    <h2 class="font-bold text-indigo-800 uppercase mb-1 flex items-center"><i data-lucide="paint-bucket" class="mr-1 w-3 h-3"></i> 一括設定</h2>
                    <div class="grid grid-cols-4 gap-1">
                        ${renderToolButton('CURSOR', 'mouse-pointer-2', '選択', 'bg-white shadow text-indigo-700 font-bold')}
                        ${renderToolButton('EMPTY', 'user-x', '空席', 'bg-gray-600 text-white shadow font-bold')}
                        ${renderToolButton('M', null, '男子', 'bg-blue-500 text-white shadow font-bold', '♂')}
                        ${renderToolButton('F', null, '女子', 'bg-pink-500 text-white shadow font-bold', '♀')}
                    </div>
                    <div class="mt-1">
                        ${renderToolButton('SWAP', 'arrow-left-right', '入れ替え', 'bg-orange-500 text-white shadow font-bold')}
                    </div>
                </section>

                <section class="text-xs border rounded p-2 bg-gray-50">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleRoster()">
                        <h2 class="font-bold text-gray-600 flex items-center"><i data-lucide="users" class="mr-1 w-3 h-3"></i> 名簿編集</h2>
                        <i data-lucide="${state.isRosterOpen ? 'chevron-down' : 'chevron-right'}" class="w-3.5 h-3.5"></i>
                    </div>
                    ${state.isRosterOpen ? `
                        <div class="mt-2 space-y-2">
                            <div>
                                <div class="flex gap-1 mb-1">
                                    <input type="text" placeholder="Spreadsheet URL" class="w-full p-1 border rounded" value="${state.importUrl}" oninput="updateImportUrl(this.value)">
                                    <button onclick="runUrlImport()" class="bg-green-600 text-white p-1 rounded"><i data-lucide="link" class="w-3 h-3"></i></button>
                                </div>
                                ${state.importError ? `<p class="text-red-500 text-[10px]">${state.importError}</p>` : ''}
                            </div>
                            <textarea class="w-full h-24 p-1 border rounded font-mono text-[10px]" oninput="updateImportText(this.value)" placeholder="1, 佐藤, 男">${state.importText}</textarea>
                            <button onclick="runImport()" class="w-full py-1 bg-gray-200 hover:bg-gray-300 rounded flex items-center justify-center gap-1 font-bold"><i data-lucide="refresh-cw" class="w-2.5 h-2.5"></i> 更新</button>
                        </div>
                    ` : ''}
                </section>

                <div class="text-xs">
                    <h2 class="font-bold text-gray-500 uppercase mb-1 flex items-center"><i data-lucide="grid" class="mr-1 w-3 h-3"></i> 配置</h2>
                    <div class="flex gap-1 mb-1 items-center">
                        <label class="w-6">横</label>
                        <button onclick="updateCols(${state.cols - 1})" class="px-1.5 py-0.5 bg-gray-200 rounded hover:bg-gray-300 font-bold">-</button>
                        <input type="number" min="1" max="12" value="${state.cols}" onchange="updateCols(this.value)" class="w-8 p-0.5 border rounded text-center">
                        <button onclick="updateCols(${state.cols + 1})" class="px-1.5 py-0.5 bg-gray-200 rounded hover:bg-gray-300 font-bold">+</button>
                    </div>
                    <div class="flex gap-1 items-center">
                        <label class="w-6">縦</label>
                        <button onclick="updateRows(${state.rows - 1})" class="px-1.5 py-0.5 bg-gray-200 rounded hover:bg-gray-300 font-bold">-</button>
                        <input type="number" min="1" max="12" value="${state.rows}" onchange="updateRows(this.value)" class="w-8 p-0.5 border rounded text-center">
                        <button onclick="updateRows(${state.rows + 1})" class="px-1.5 py-0.5 bg-gray-200 rounded hover:bg-gray-300 font-bold">+</button>
                    </div>
                </div>
                
                <button onclick="toggleBlackboard()" class="w-full py-1 bg-white border rounded hover:bg-gray-50 flex items-center justify-center gap-1 text-gray-700 text-xs"><i data-lucide="arrow-up-down" class="w-3 h-3"></i> 黒板: ${state.blackboardPosition === 'top' ? '上' : '下'}</button>
            </aside>`;

            // メインエリア (スクロール可 + 座席のアスペクト比変更)
            const blackboard = `<div class="w-[70%] h-12 md:h-20 bg-[#1a472a] border-y-4 border-[#5d4037] shadow-xl relative mb-2 flex-shrink-0 flex items-center justify-center overflow-hidden rounded-sm print:hidden"><div class="absolute bottom-1 right-4 w-8 h-1.5 bg-white/50 rounded-full rotate-1 shadow-sm"></div></div>`;
            
            let gridCells = '';
            displayIndices.forEach(i => {
                const studentId = state.seats[i];
                const student = studentId ? getStudent(studentId) : null;
                const isLocked = state.lockedSeats[i];
                const attr = state.seatAttributes[i];
                const isSwapping = state.activeTool === 'SWAP' && state.swapSourceIndex === i;
                
                let bgColor = 'bg-gray-50';
                let ringColor = isSwapping ? 'ring-4 ring-orange-400 z-10' : ''; // 入れ替え選択中は強調
                
                // アニメーションスタイル
                let style = '';
                if (state.isShuffling) {
                    const rX = (Math.random()-0.5)*50;
                    const rY = (Math.random()-0.5)*50;
                    const rR = (Math.random()-0.5)*360;
                    style = `transform: translate(${rX}px,${rY}px) rotate(${rR}deg) scale(0.9); transition: transform 0.5s ease-in-out; z-index: 100; opacity: 0.8;`;
                } else {
                    style = `transition: transform 0.5s ease-out;`;
                }

                if (!isSwapping) {
                    if (student) {
                        // 生徒がいる場合は生徒の色を優先（席替え実行後の表示を統一）
                        bgColor = student.gender === 'M' ? 'bg-blue-100' : 'bg-pink-100';
                        if (isLocked) { ringColor = 'ring-2 ring-red-500 z-10'; } // ロック状態は枠線で表示
                    } else {
                        // 生徒がいない場合（設定中）
                        if (isLocked) { bgColor = 'bg-white'; ringColor = 'ring-1 ring-red-400'; }
                        else if (attr === 'EMPTY') { bgColor = 'bg-gray-200'; }
                        else if (attr === 'M') { bgColor = 'bg-blue-50 border-blue-300 border border-dashed'; }
                        else if (attr === 'F') { bgColor = 'bg-pink-50 border-pink-300 border border-dashed'; }
                    }
                }

                let content = '';
                if (student) {
                    content = `<div class="w-full text-center flex flex-col justify-center h-full p-0.5 relative">
                        <span class="text-[10px] md:text-xs text-gray-500 font-bold leading-none mb-0.5 absolute top-0 left-1">${student.number}</span>
                        <div class="student-name text-[10px] md:text-xs lg:text-sm font-bold text-gray-800 leading-tight w-full break-all line-clamp-2 flex items-center justify-center h-full pt-1">${student.name}</div>
                    </div>`;
                } else {
                    content = `<span class="text-gray-300 font-bold text-[10px]">${attr === 'EMPTY' ? '×' : i+1}</span>`;
                }

                let icons = '';
                // ロックアイコンなどは枠線で表現するので、ここでは最小限に
                if (isLocked) icons += `<i data-lucide="lock" class="w-2 h-2 text-red-500"></i>`;
                if (!student) { // 生徒がいないときだけ属性を表示（生徒がいたら色でわかるため）
                    if (attr === 'M') icons += `<span class="text-[8px] font-bold text-blue-500">♂</span>`;
                    if (attr === 'F') icons += `<span class="text-[8px] font-bold text-pink-500">♀</span>`;
                }

                // aspect-[3/2] で横長（縦幅縮小）に
                gridCells += `
                    <div onclick="handleSeatClick(${i})" class="seat-cell aspect-[3/2] rounded border shadow-sm flex flex-col items-center justify-center cursor-pointer relative group border-gray-300 hover:border-gray-500 ${bgColor} ${ringColor} print:border-gray-800 print:shadow-none print:ring-0 overflow-hidden" style="${style}">
                        <div class="absolute top-0.5 left-0.5 flex gap-0.5 z-10">${icons}</div>
                        ${content}
                    </div>
                `;
            });

            return `
                ${sidebar}
                <main class="flex-1 bg-gray-100 p-2 overflow-y-auto flex flex-col items-center justify-start min-h-0 pb-[100px]">
                    <div id="capture-container" class="flex flex-col items-center justify-center bg-gray-100 p-1 rounded-xl print:p-0 print:bg-white w-full h-auto min-h-full">
                        ${state.blackboardPosition === 'top' ? blackboard : ''}
                        <div class="seat-grid grid gap-1 p-1 bg-white rounded-lg shadow-inner w-full h-full" 
                             style="grid-template-columns: repeat(${state.cols}, minmax(0, 1fr));">
                            ${gridCells}
                        </div>
                        ${state.blackboardPosition === 'bottom' ? blackboard.replace('mb-2', 'mt-2') : ''}
                    </div>
                </main>
            `;
        }

        function renderStudentMode() {
            const displayIndices = Array.from({ length: state.seats.length }, (_, i) => i);
            if (state.blackboardPosition === 'bottom') displayIndices.reverse();

            const controls = `
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent opacity-0 hover:opacity-100 transition-opacity z-50 flex justify-center items-center gap-4 print:hidden h-24">
                <button onclick="setMode('teacher')" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white text-base rounded backdrop-blur font-bold">設定</button>
                <button onclick="toggleBlackboard()" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white text-base rounded backdrop-blur font-bold"><i data-lucide="arrow-up-down" class="w-5 h-5"></i></button>
                <button onclick="toggleSound()" class="p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur"><i data-lucide="${state.isSoundEnabled ? 'volume-2' : 'volume-x'}" class="w-5 h-5"></i></button>
                <div class="w-px h-10 bg-white/20 mx-2"></div>
                <button onclick="shuffleSeatsWithAnimation()" ${state.isShuffling ? 'disabled' : ''} class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-500 text-white rounded shadow-lg font-bold flex items-center gap-2 transition-all active:scale-95 text-base"><i data-lucide="shuffle" class="w-5 h-5"></i> 席替え</button>
                <button onclick="drumRollReveal()" ${state.isShuffling ? 'disabled' : ''} class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-500 text-black font-bold text-base rounded shadow-lg flex items-center gap-2 transition-all active:scale-95">公開</button>
                <button onclick="revealAll()" ${state.isShuffling ? 'disabled' : ''} class="px-8 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-500 text-white font-bold rounded shadow-lg transition-all active:scale-95 text-base">一斉</button>
            </div>`;

            const blackboard = `<div class="w-[70%] h-12 md:h-20 bg-[#1a472a] border-y-4 border-[#5d4037] shadow-xl relative mb-2 flex-shrink-0 flex items-center justify-center overflow-hidden rounded-sm print:hidden"><div class="absolute bottom-1 right-4 w-8 h-1.5 bg-white/50 rounded-full rotate-1 shadow-sm"></div></div>`;

            let gridCells = '';
            displayIndices.forEach(originalIndex => {
                const i = originalIndex;
                const studentId = state.seats[i];
                const student = studentId ? getStudent(studentId) : null;
                const isRevealed = state.revealState[i];
                const attr = state.seatAttributes[i];

                if (!student && (attr === 'EMPTY' || !studentId)) {
                    gridCells += `<div class="border-2 border-dashed border-white/5 rounded flex items-center justify-center opacity-50"><span class="text-white/20 text-xs">×</span></div>`;
                    return;
                }

                let style = '';
                if (state.isShuffling) {
                    const rX = (Math.random()-0.5)*200;
                    const rY = (Math.random()-0.5)*200;
                    const rR = (Math.random()-0.5)*360;
                    style = `transform: translate(${rX}px,${rY}px) rotate(${rR}deg) scale(0.8); transition: transform 0.5s ease-in-out; z-index: 100; opacity: 0.7;`;
                } else {
                    style = `transition: transform 0.5s ease-out;`;
                }

                const faceFront = `
                    <div class="absolute inset-0 backface-hidden bg-[#f0e6d2] rounded shadow-sm border-b-2 border-r-2 border-[#d7ccc8] flex items-center justify-center">
                        <div class="w-full h-full border border-dashed border-[#a1887f]/50 rounded m-0.5 flex flex-col items-center justify-center">
                            <span class="text-[8px] md:text-xs font-bold text-[#8d6e63] opacity-40">No.</span>
                            <span class="text-lg md:text-2xl font-bold text-[#8d6e63] opacity-30">${student?.number || '-'}</span>
                        </div>
                    </div>`;
                
                const bgColor = student?.gender === 'M' ? 'bg-blue-100 border-blue-200' : 'bg-pink-100 border-pink-200';
                const faceBack = `
                    <div class="absolute inset-0 backface-hidden rotate-y-180 rounded shadow-sm border flex flex-col items-center justify-center p-0.5 ${bgColor}" style="transform: rotateY(180deg); backface-visibility: hidden;">
                        ${student ? `
                            <span class="text-[8px] md:text-[10px] text-gray-500 font-bold absolute top-0.5 left-1">${student.number}</span>
                            <div class="text-xs md:text-lg lg:text-xl font-black text-gray-800 break-all leading-tight text-center w-full px-0.5 line-clamp-2">${student.name}</div>
                        ` : `<span class="text-gray-300 font-bold text-xs">空</span>`}
                    </div>`;

                const rotateClass = (isRevealed && !state.isShuffling) ? 'rotateY(180deg)' : 'rotateY(0deg)';

                gridCells += `
                    <div onclick="studentToggleCard(${i})" class="perspective-1000 cursor-pointer group relative w-full h-full" style="perspective: 1000px; ${style}">
                        <div class="relative w-full h-full transition-all duration-500 transform-style-3d" style="transform: ${rotateClass};">
                            ${faceFront}
                            ${faceBack}
                        </div>
                    </div>
                `;
            });

            return `
                <div class="fixed inset-0 bg-[#2b3a42] flex flex-col items-center overflow-hidden font-sans">
                    <div class="absolute inset-0 pointer-events-none opacity-10 bg-repeat" style="background-image: radial-gradient(circle, #ffffff 1px, transparent 1px); background-size: 24px 24px;"></div>
                    <div class="flex-1 w-full p-1 md:p-2 flex flex-col items-center justify-center overflow-hidden z-10 pb-[100px]">
                        ${state.blackboardPosition === 'top' ? blackboard : ''}
                        <div class="grid gap-1 md:gap-2 w-full h-full flex-1" style="grid-template-columns: repeat(${state.cols}, minmax(0, 1fr)); grid-template-rows: repeat(${state.rows}, minmax(0, 1fr));">
                            ${gridCells}
                        </div>
                        ${state.blackboardPosition === 'bottom' ? blackboard.replace('mb-2', 'mt-2') : ''}
                    </div>
                    ${controls}
                </div>
            `;
        }

        function renderToolButton(tool, icon, label, activeClass, textIcon = '') {
            const isActive = state.activeTool === tool;
            const baseClass = "p-1 rounded flex flex-col md:flex-row items-center justify-center gap-1 w-full";
            const colorClass = isActive ? activeClass : 'hover:bg-white/50 text-indigo-600';
            const iconHtml = icon ? `<i data-lucide="${icon}" class="w-3 h-3"></i>` : '';
            
            return `<button onclick="setActiveTool('${tool}')" class="${baseClass} ${colorClass}">
                ${iconHtml} ${textIcon} <span>${label}</span>
            </button>`;
        }

        function renderSaveMenu() {
            return `
                <div class="absolute top-full left-0 mt-1 w-32 bg-white border rounded shadow-xl z-50 py-1 text-left">
                    <button onclick="event.stopPropagation(); prepareAndCapture('pdf')" class="w-full text-left px-2 py-1 hover:bg-gray-50 flex items-center gap-1 text-xs text-gray-700"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</button>
                    <button onclick="event.stopPropagation(); prepareAndCapture('png')" class="w-full text-left px-2 py-1 hover:bg-gray-50 flex items-center gap-1 text-xs text-gray-700"><i data-lucide="image" class="w-3 h-3"></i> 画像</button>
                </div>
            `;
        }

        function renderModal() {
            const content = document.getElementById('modal-content');
            if (!content || state.editingSeatIndex === null) return;

            const index = state.editingSeatIndex;
            const currentSeatId = state.seats[index];
            const currentAttr = state.seatAttributes[index];
            
            const placedStudentIds = new Set(state.seats.filter(id => id !== null && id !== currentSeatId));
            const availableStudents = state.students.filter(s => !placedStudentIds.has(s.id));
            const filteredStudents = availableStudents.filter(s => (s.name || '').includes(state.searchQuery));

            let listHtml = '';
            filteredStudents.forEach(s => {
                listHtml += `
                <button onclick="editSeat('SET_STUDENT', '${s.id}')" class="w-full p-2 text-left flex justify-between items-center hover:bg-indigo-50 text-xs">
                    <div class="flex items-center gap-2"><span class="text-gray-500 w-5">${s.number}</span><span>${s.name}</span></div>
                    <span class="px-1.5 py-0.5 rounded ${s.gender === 'M' ? 'bg-blue-100' : 'bg-pink-100'}">${s.gender === 'M' ? '男' : '女'}</span>
                </button>`;
            });

            content.innerHTML = `
                <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-base">座席設定 (No.${index + 1})</h3>
                    <button onclick="closeModal()"><i data-lucide="x-circle" class="text-gray-400 hover:text-gray-600 w-5 h-5"></i></button>
                </div>
                <div class="p-3 overflow-y-auto">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="editSeat('SET_EMPTY')" class="p-2 border rounded flex items-center justify-center gap-1 text-xs ${currentAttr === 'EMPTY' ? 'bg-gray-200' : 'hover:bg-gray-50'}"><i data-lucide="user-x" class="w-3.5 h-3.5"></i> 空席</button>
                        <button onclick="editSeat('SET_ATTRIBUTE', null)" class="p-2 border rounded flex items-center justify-center gap-1 text-xs ${!currentAttr && !state.lockedSeats[index] ? 'bg-white ring-2 ring-indigo-400' : 'hover:bg-gray-50'}"><i data-lucide="user" class="w-3.5 h-3.5"></i> 指定なし</button>
                        <button onclick="editSeat('SET_ATTRIBUTE', 'M')" class="p-2 border rounded flex items-center justify-center gap-1 text-xs ${currentAttr === 'M' ? 'bg-blue-100 ring-2' : 'hover:bg-blue-50'}"><span class="text-blue-600 font-bold">♂</span> 男子席</button>
                        <button onclick="editSeat('SET_ATTRIBUTE', 'F')" class="p-2 border rounded flex items-center justify-center gap-1 text-xs ${currentAttr === 'F' ? 'bg-pink-100 ring-2' : 'hover:bg-pink-50'}"><span class="text-pink-600 font-bold">♀</span> 女子席</button>
                    </div>
                    <hr class="my-2" />
                    <input type="text" placeholder="名前検索..." class="w-full p-2 border rounded mb-2 text-xs" value="${state.searchQuery}" oninput="updateSearchQuery(this.value)">
                    <div class="h-40 overflow-y-auto border rounded divide-y">
                        ${listHtml}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // 初期化
        window.onload = () => {
            parseStudents(INITIAL_STUDENTS_TEXT);
            initSeats(); // 重要：初期座席作成
        };

    </script>
</body>
</html>
