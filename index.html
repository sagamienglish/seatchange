<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>座席替えツール プロ版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .perspective-1000 { perspective: 1000px; }
        @media print { .print\:hidden { display: none !important; } }
    </style>
</head>
<body>
    <div id="root">
        <div id="error-display" style="padding: 20px; color: #666; font-family: sans-serif; text-align: center;">
            <p>高機能版システムをロード中...</p>
        </div>
    </div>

    <script type="text/babel">
        // ブラウザ上で import を使わずに済むように全ての機能を再構築
        const { useState, useEffect, useRef, useCallback } = React;
        const { 
            Settings, Users, Shuffle, Monitor, Printer, RefreshCw, Grid, Lock, Unlock, 
            ArrowUpDown, Volume2, VolumeX, User, UserX, CheckCircle, XCircle, 
            MousePointer2, PaintBucket, Link: LinkIcon, AlertCircle, Download, FileText, Image: ImageIcon 
        } = lucide;

        // --- 音声生成 (元のコードの音響ロジックを完全再現) ---
        const useSound = () => {
            const [audioCtx, setAudioCtx] = useState(null);
            const [enabled, setEnabled] = useState(true);
            useEffect(() => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) setAudioCtx(new AudioContext());
            }, []);
            const playTone = useCallback((freq, type, duration, startTime = 0, vol = 0.1) => {
                if (!audioCtx || !enabled) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
                gain.gain.setValueAtTime(0, audioCtx.currentTime + startTime);
                gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + startTime); osc.stop(audioCtx.currentTime + startTime + duration);
            }, [audioCtx, enabled]);

            return {
                playFlip: () => playTone(1000, 'sine', 0.1, 0, 0.05),
                playDrumroll: () => { if(audioCtx && enabled) for (let i = 0; i < 15; i++) playTone(150 + (i * 20), 'triangle', 0.1, i * 0.1, 0.15); },
                playTada: () => { if(audioCtx && enabled) [523, 659, 783, 1046].forEach((f, i) => playTone(f, 'triangle', 1.5, i * 0.1, 0.1)); },
                enabled, setEnabled
            };
        };

        const INITIAL_TEXT = `1, 佐藤 健, 男\n2, 鈴木 愛, 女\n3, 高橋 翔, 男\n4, 田中 美咲, 女\n5, 伊藤 翼, 男\n6, 渡辺 結衣, 女\n7, 山本 蓮, 男\n8, 中村 陽菜, 女`;

        function App() {
            const [mode, setMode] = useState('teacher');
            const [students, setStudents] = useState([]);
            const [rows, setRows] = useState(8);
            const [cols, setCols] = useState(6);
            const [seats, setSeats] = useState([]);
            const [lockedSeats, setLockedSeats] = useState({});
            const [seatAttributes, setSeatAttributes] = useState({});
            const [importText, setImportText] = useState(INITIAL_TEXT);
            const [revealState, setRevealState] = useState({});
            const [isShuffling, setIsShuffling] = useState(false);
            const [activeTool, setActiveTool] = useState('CURSOR');
            const { playFlip, playDrumroll, playTada, enabled: soundOn, setEnabled: setSoundOn } = useSound();
            const captureRef = useRef(null);

            useEffect(() => { applyList(INITIAL_TEXT); }, []);
            useEffect(() => { 
                const size = rows * cols;
                setSeats(prev => {
                    const n = new Array(size).fill(null);
                    for(let i=0; i<Math.min(prev.length, size); i++) n[i] = prev[i];
                    return n;
                });
            }, [rows, cols]);

            const applyList = (text) => {
                const lines = text.trim().split('\n');
                const parsed = lines.map((l, i) => {
                    const p = l.split(/[,\t]/).map(s => s.trim());
                    return { id: `s-${i}`, number: p[0], name: p[1] || `生徒${i+1}`, gender: (p[2] && p[2].includes('女')) ? 'F' : 'M' };
                });
                setStudents(parsed);
            };

            const shuffle = () => {
                if (mode === 'student') { 
                    setIsShuffling(true); playDrumroll();
                    setTimeout(() => { executeShuffle(); setIsShuffling(false); playTada(); }, 1600);
                } else executeShuffle();
            };

            const executeShuffle = () => {
                let newSeats = [...seats];
                const lockedIds = new Set();
                seats.forEach((sid, i) => { if(lockedSeats[i] && sid) lockedIds.add(sid); else newSeats[i] = null; });
                let pool = students.filter(s => !lockedIds.has(s.id));
                let boys = pool.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
                let girls = pool.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);
                
                seats.forEach((_, i) => {
                    if(!newSeats[i]) {
                        if(seatAttributes[i] === 'M' && boys.length > 0) newSeats[i] = boys.pop().id;
                        else if(seatAttributes[i] === 'F' && girls.length > 0) newSeats[i] = girls.pop().id;
                    }
                });
                let remain = [...boys, ...girls].sort(() => Math.random() - 0.5);
                seats.forEach((_, i) => { if(!newSeats[i] && seatAttributes[i] !== 'EMPTY' && remain.length > 0) newSeats[i] = remain.pop().id; });
                setSeats(newSeats); setRevealState({});
            };

            const handleSeatClick = (i) => {
                if (mode === 'teacher') {
                    if (activeTool === 'EMPTY') {
                        setSeatAttributes(p => ({...p, [i]: p[i]==='EMPTY'?null:'EMPTY'}));
                        setSeats(prev => { const n = [...prev]; n[i] = null; return n; });
                        setLockedSeats(p => ({...p, [i]: false}));
                    }
                    else if (activeTool === 'M') setSeatAttributes(p => ({...p, [i]: p[i]==='M'?null:'M'}));
                    else if (activeTool === 'F') setSeatAttributes(p => ({...p, [i]: p[i]==='F'?null:'F'}));
                    else setLockedSeats(p => ({...p, [i]: !p[i]}));
                } else {
                    if (!isShuffling) { playFlip(); setRevealState(p => ({...p, [i]: !p[i]})); }
                }
            };

            const saveImage = async () => {
                const canvas = await html2canvas(captureRef.current);
                const link = document.createElement('a');
                link.download = '座席表.png'; link.href = canvas.toDataURL(); link.click();
            };

            return (
                <div className="min-h-screen flex flex-col no-scrollbar">
                    <header className="bg-white p-3 border-b flex justify-between items-center shadow-sm z-50 print:hidden">
                        <div className="flex items-center gap-2">
                            <Settings size={20} className="text-gray-500" />
                            <h1 className="font-bold text-gray-700">教員用設定</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={shuffle} className="bg-indigo-600 text-white px-4 py-1.5 rounded-lg font-bold shadow flex items-center gap-1 active:scale-95 transition-all"><Shuffle size={16}/> 実行</button>
                            <button onClick={() => window.print()} className="bg-gray-100 px-4 py-1.5 rounded-lg font-bold flex items-center gap-1"><Printer size={16}/> 印刷</button>
                            <button onClick={saveImage} className="bg-gray-100 px-4 py-1.5 rounded-lg font-bold flex items-center gap-1"><Download size={16}/> 保存</button>
                            <button onClick={() => setMode(mode==='teacher'?'student':'teacher')} className="bg-teal-600 text-white px-4 py-1.5 rounded-lg font-bold shadow flex items-center gap-1 active:scale-95 ml-2">
                                {mode==='teacher' ? <><Monitor size={16}/>生徒モード</> : <><Settings size={16}/>設定へ</>}
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {mode === 'teacher' && (
                            <aside className="w-72 bg-white border-r p-4 overflow-y-auto space-y-6 shadow-inner print:hidden">
                                <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                    <h2 className="text-[10px] font-bold text-indigo-800 uppercase mb-2 flex items-center gap-1"><PaintBucket size={12}/> 一括設定ツール</h2>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => setActiveTool('CURSOR')} className={`p-2 text-[10px] border rounded font-bold ${activeTool === 'CURSOR' ? 'bg-indigo-600 text-white shadow' : 'bg-white'}`}>選択/詳細</button>
                                        <button onClick={() => setActiveTool('EMPTY')} className={`p-2 text-[10px] border rounded font-bold ${activeTool === 'EMPTY' ? 'bg-gray-700 text-white shadow' : 'bg-white'}`}>空席ペン</button>
                                        <button onClick={() => setActiveTool('M')} className={`p-2 text-[10px] border rounded font-bold ${activeTool === 'M' ? 'bg-blue-500 text-white shadow' : 'bg-white text-blue-600'}`}>♂ 男子席ペン</button>
                                        <button onClick={() => setActiveTool('F')} className={`p-2 text-[10px] border rounded font-bold ${activeTool === 'F' ? 'bg-pink-500 text-white shadow' : 'bg-white text-pink-600'}`}>♀ 女子席ペン</button>
                                    </div>
                                    <p className="text-[9px] text-indigo-400 mt-2 text-center">ペンを選んで座席をクリックで連続設定</p>
                                </div>
                                <div>
                                    <h2 className="text-[10px] font-bold text-gray-400 mb-2 uppercase flex items-center gap-1"><Users size={12}/> 生徒名簿 (名簿更新 48名)</h2>
                                    <textarea className="w-full h-40 text-[10px] p-2 border bg-gray-50 font-mono rounded" value={importText} onChange={e => setImportText(e.target.value)} />
                                    <button onClick={() => applyList(importText)} className="w-full bg-gray-200 py-1.5 text-[10px] rounded mt-1 font-bold flex items-center justify-center gap-1 hover:bg-gray-300 transition-colors"><RefreshCw size={12}/>反映</button>
                                </div>
                                <div>
                                    <h2 className="text-[10px] font-bold text-gray-400 mb-2 uppercase flex items-center gap-1"><Grid size={12}/> レイアウト</h2>
                                    <div className="flex gap-2 mb-2 items-center">
                                        <span className="text-[10px]">横</span>
                                        <input type="number" value={cols} onChange={e => setCols(parseInt(e.target.value))} className="w-full border p-1 rounded text-center text-xs" />
                                        <span className="text-[10px]">縦</span>
                                        <input type="number" value={rows} onChange={e => setRows(parseInt(e.target.value))} className="w-full border p-1 rounded text-center text-xs" />
                                    </div>
                                </div>
                            </aside>
                        )}

                        <main className={`flex-1 overflow-auto p-4 flex flex-col items-center transition-colors duration-500 ${mode==='student' ? 'bg-[#2b3a42]' : 'bg-gray-100'}`}>
                            <div ref={captureRef} className="w-full max-w-5xl flex flex-col items-center">
                                <div className="w-full bg-[#1a472a] h-12 border-y-4 border-[#5d4037] mb-8 flex items-center justify-center rounded shadow-xl relative">
                                    <div className="absolute right-4 bottom-1 w-8 h-1 bg-white/20 rounded-full"></div>
                                    <span className="text-white/10 tracking-[1em] font-bold text-xs uppercase">Blackboard</span>
                                </div>
                                <div className="grid gap-2 w-full" style={{ gridTemplateColumns: `repeat(${cols}, 1fr)` }}>
                                    {seats.map((sid, i) => {
                                        const s = students.find(x => x.id === sid);
                                        const rev = revealState[i] || mode === 'teacher';
                                        const attr = seatAttributes[i];
                                        let bg = s ? (s.gender==='M'?'bg-blue-100':'bg-pink-100') : 'bg-white';
                                        if (attr === 'EMPTY') bg = 'bg-gray-200';
                                        else if (attr === 'M') bg = 'bg-blue-50 border-blue-200 border-dashed border-2';
                                        else if (attr === 'F') bg = 'bg-pink-50 border-pink-200 border-dashed border-2';
                                        
                                        return (
                                            <div key={i} onClick={() => handleSeatClick(i)} className="aspect-[4/3] perspective-1000 cursor-pointer">
                                                <div className={`w-full h-full relative preserve-3d transition-transform duration-500 ${rev?'rotate-y-180':''}`} style={{ transform: rev?'rotateY(180deg)':'none' }}>
                                                    <div className="absolute inset-0 flex items-center justify-center backface-hidden rounded-lg bg-[#f0e6d2] border-2 border-[#8d6e63]/20 shadow-sm">
                                                        <span className="text-2xl font-bold text-[#8d6e63] opacity-20">{s?.number}</span>
                                                    </div>
                                                    <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden rotate-y-180 rounded-lg shadow-md ${bg}`} style={{ transform: 'rotateY(180deg)' }}>
                                                        {s && <><span className="text-[10px] text-gray-500 mb-1 font-bold">{s.number}</span><span className="font-bold text-sm lg:text-base text-gray-800">{s.name}</span></>}
                                                        {!s && attr==='EMPTY' && <span className="text-gray-400 text-xs font-bold">空席</span>}
                                                        {lockedSeats[i] && <div className="absolute top-1 right-1"><Lock size={10} className="text-red-500"/></div>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            {mode === 'student' && (
                                <div className="fixed bottom-6 flex gap-3 bg-black/40 p-4 rounded-full backdrop-blur-md shadow-2xl z-50 transition-all hover:bg-black/60">
                                    <button onClick={() => setSoundOn(!soundOn)} className="text-white opacity-50 px-2 transition-opacity hover:opacity-100"><Volume2 size={18} className={soundOn?"":"hidden"}/><VolumeX size={18} className={soundOn?"hidden":""}/></button>
                                    <button onClick={shuffle} disabled={isShuffling} className="bg-indigo-600 text-white px-8 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 active:scale-95 transition-all"><Shuffle size={20}/>シャッフル開始</button>
                                    <button onClick={() => { playTada(); const ns={}; seats.forEach((_,i)=>ns[i]=true); setRevealState(ns); }} className="bg-green-600 text-white px-8 py-2 rounded-full font-bold shadow-lg active:scale-95 transition-all">一斉公開</button>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
