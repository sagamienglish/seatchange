<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>席替えくん</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- html2canvas & jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        @media print {
            @page { size: landscape; margin: 5mm; }
            .print\:hidden { display: none !important; }
            body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full w-full flex flex-col overflow-hidden"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal()">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh]" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        // --- データ定義 ---
        const INITIAL_STUDENTS_TEXT = `1, 佐藤 健, 男
2, 鈴木 愛, 女
3, 高橋 翔, 男
4, 田中 美咲, 女
5, 伊藤 翼, 男
6, 渡辺 結衣, 女
7, 山本 蓮, 男
8, 中村 陽菜, 女
9, 小林 湊, 男
10, 加藤 葵, 女
11, 吉田 樹, 男
12, 山田 凛, 女
13, 佐々木 陸, 男
14, 山口 澪, 女
15, 松本 蒼, 男
16, 井上 紬, 女
17, 木村 大和, 男
18, 林 杏奈, 女
19, 斎藤 悠真, 男
20, 清水 桜, 女
21, 山崎 瑛太, 男
22, 池田 楓, 女
23, 橋本 朝陽, 男
24, 阿部 菫, 女
25, 宮本 琉生, 男
26, 石川 陽菜, 女
27, 中川 湊斗, 男
28, 野口 結菜, 女
29, 酒井 大翔, 男
30, 村上 莉子, 女
31, 小川 悠人, 男
32, 長谷川 咲良, 女
33, 岡田 陽向, 男
34, 藤田 結衣, 女
35, 後藤 陸, 男
36, 近藤 陽菜, 女
37, 石井 湊, 男
38, 小島 葵, 女
39, 遠藤 樹, 男
40, 青木 凛, 女
41, 藤井 陸, 男
42, 西村 澪, 女
43, 安藤 蒼, 男
44, 辻 紬, 女
45, 山下 大和, 男
46, 岡本 杏奈, 女
47, 森本 悠真, 男
48, 今井 桜, 女`;

        // --- 状態管理 ---
        const state = {
            mode: 'teacher', 
            students: [],
            rows: 8,
            cols: 6,
            seats: [], 
            lockedSeats: {}, 
            seatAttributes: {}, 
            importText: INITIAL_STUDENTS_TEXT,
            importUrl: '',
            revealState: {},
            blackboardPosition: 'top',
            isShuffling: false,
            activeTool: 'CURSOR', 
            swapSourceIndex: null, 
            editingSeatIndex: null,
            searchQuery: '',
            showSaveMenu: false,
            isRosterOpen: true, 
            isSoundEnabled: true,
            isStudentControlsVisible: true,
            isSidebarCollapsed: false 
        };

        // --- 音声再生 ---
        let audioCtx = null;
        function initAudio() {
            const AC = window.AudioContext || window.webkitAudioContext;
            if (AC && !audioCtx) audioCtx = new AC();
        }
        function playTone(freq, type, duration, startTime = 0, vol = 0.1) {
            if (!audioCtx || !state.isSoundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
                gain.gain.setValueAtTime(0, audioCtx.currentTime + startTime);
                gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + startTime); osc.stop(audioCtx.currentTime + startTime + duration);
            } catch(e){}
        }
        function playFlip() { initAudio(); playTone(1000 + Math.random() * 200, 'sine', 0.1, 0, 0.08); }
        function playDrumroll() {
            initAudio();
            if (!audioCtx || !state.isSoundEnabled) return;
            for (let i = 0; i < 12; i++) { playTone(150 + (i * 25), 'triangle', 0.1, i * 0.10, 0.15); }
        }
        function playTada() {
            initAudio();
            if (!audioCtx || !state.isSoundEnabled) return;
            [523.25, 659.25, 783.99, 987.77, 1174.66].forEach((freq, i) => { playTone(freq, 'triangle', 1.8, i * 0.06, 0.15); });
        }

        // --- ロジック ---
        function parseStudents(text) {
            const lines = text.trim().split('\n');
            state.students = lines.map((line, i) => {
                const parts = line.split(/[,\t]/).map(p => p.trim()).filter(p => p);
                let num = i + 1, name = `生徒${i+1}`, gender = 'M';
                if (parts.length >= 3) {
                    if (!isNaN(parseInt(parts[0]))) { num = parseInt(parts[0]); name = parts[1]; gender = (parts[2].includes('女') || parts[2].toLowerCase().includes('f')) ? 'F' : 'M'; }
                    else { name = parts[0]; gender = (parts[1].includes('女') || parts[1].toLowerCase().includes('f')) ? 'F' : 'M'; }
                } else if (parts.length === 2) {
                    if (!isNaN(parseInt(parts[0]))) { num = parseInt(parts[0]); name = parts[1]; }
                    else { name = parts[0]; gender = (parts[1].includes('女') || parts[1].toLowerCase().includes('f')) ? 'F' : 'M'; }
                } else if (parts.length === 1) { name = parts[0]; }
                return { id: `s-${i}`, number: num, name, gender };
            });
        }

        function initSeats() {
            const newSize = state.rows * state.cols;
            const newSeats = new Array(newSize).fill(null);
            for (let i = 0; i < Math.min(state.seats.length, newSize); i++) {
                newSeats[i] = state.seats[i];
            }
            state.seats = newSeats;
            const resizeObj = (prev) => {
                const next = {};
                Object.keys(prev).forEach(key => { if (parseInt(key) < newSize) next[key] = prev[key]; });
                return next;
            };
            state.lockedSeats = resizeObj(state.lockedSeats);
            state.seatAttributes = resizeObj(state.seatAttributes);
            render();
        }

        function shuffleSeatsLogic() {
            let newSeats = [...state.seats];
            const lockedIds = new Set();
            for (let i = 0; i < newSeats.length; i++) {
                if (state.lockedSeats[i] && newSeats[i]) lockedIds.add(newSeats[i]);
                else newSeats[i] = null;
            }
            let pool = state.students.filter(s => !lockedIds.has(s.id));
            let boys = pool.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
            let girls = pool.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < newSeats.length; i++) {
                if (state.lockedSeats[i]) continue;
                const attr = state.seatAttributes[i];
                if (attr === 'M' && boys.length > 0) newSeats[i] = boys.pop().id;
                else if (attr === 'F' && girls.length > 0) newSeats[i] = girls.pop().id;
            }
            let remaining = [...boys, ...girls].sort(() => Math.random() - 0.5);
            for (let i = 0; i < newSeats.length; i++) {
                if (!newSeats[i] && state.seatAttributes[i] !== 'EMPTY' && remaining.length > 0) {
                    newSeats[i] = remaining.pop().id;
                }
            }
            state.seats = newSeats;
            state.revealState = {};
            render();
        }

        function shuffleSeatsWithAnimation() {
            if (state.isShuffling) return;
            state.isShuffling = true;
            playDrumroll();
            render();
            setTimeout(() => {
                shuffleSeatsLogic();
                state.isShuffling = false;
                playTada();
                render();
            }, 1500);
        }

        // --- ウィンドウ操作 ---
        window.setMode = (m) => { state.mode = m; render(); };
        window.toggleSound = () => { state.isSoundEnabled = !state.isSoundEnabled; render(); };
        window.toggleSaveMenu = () => { state.showSaveMenu = !state.showSaveMenu; render(); };
        window.setActiveTool = (t) => { state.activeTool = t; state.swapSourceIndex = null; render(); };
        window.toggleRoster = () => { state.isRosterOpen = !state.isRosterOpen; render(); };
        window.updateImportText = (v) => { state.importText = v; };
        window.runImport = () => { parseStudents(state.importText); initSeats(); };
        window.updateRows = (v) => { state.rows = Math.max(1, parseInt(v) || 1); initSeats(); };
        window.updateCols = (v) => { state.cols = Math.max(1, parseInt(v) || 1); initSeats(); };
        window.toggleBlackboard = () => { state.blackboardPosition = state.blackboardPosition === 'top' ? 'bottom' : 'top'; render(); };
        window.clearSeats = () => { state.seats = state.seats.map((id, i) => state.lockedSeats[i] ? id : null); state.revealState = {}; render(); };
        window.toggleSidebar = () => { state.isSidebarCollapsed = !state.isSidebarCollapsed; render(); };
        window.toggleControls = (v) => { state.isStudentControlsVisible = v; render(); };

        window.handleSeatClick = (i) => {
            if (state.activeTool === 'CURSOR') openSeatModal(i);
            else if (state.activeTool === 'EMPTY') { 
                state.seatAttributes[i] = state.seatAttributes[i] === 'EMPTY' ? null : 'EMPTY'; 
                if(state.seatAttributes[i]){state.seats[i]=null; state.lockedSeats[i]=false;} 
                render(); 
            }
            else if (state.activeTool === 'M') { state.seatAttributes[i] = state.seatAttributes[i] === 'M' ? null : 'M'; state.lockedSeats[i]=false; render(); }
            else if (state.activeTool === 'F') { state.seatAttributes[i] = state.seatAttributes[i] === 'F' ? null : 'F'; state.lockedSeats[i]=false; render(); }
            else if (state.activeTool === 'SWAP') {
                if (state.swapSourceIndex === null) state.swapSourceIndex = i;
                else {
                    const temp = state.seats[state.swapSourceIndex];
                    state.seats[state.swapSourceIndex] = state.seats[i];
                    state.seats[i] = temp;
                    state.swapSourceIndex = null;
                }
                render();
            }
        };

        window.studentToggleCard = (i) => { if (state.isShuffling) return; playFlip(); state.revealState[i] = !state.revealState[i]; render(); };
        window.revealAll = () => { playTada(); state.seats.forEach((_, i) => state.revealState[i] = true); render(); };
        window.drumRollReveal = () => {
            playDrumroll(); state.revealState = {}; render();
            const ids = state.seats.map((_, i) => i).sort(() => Math.random() - 0.5);
            ids.forEach((idx, i) => setTimeout(() => { state.revealState[idx] = true; playFlip(); render(); }, i * 300 + 1000));
        };
        window.hideAll = () => { state.revealState = {}; render(); };

        function openSeatModal(i) { state.editingSeatIndex = i; state.searchQuery = ''; renderModal(); document.getElementById('modal-overlay').classList.remove('hidden'); }
        window.closeModal = () => { state.editingSeatIndex = null; document.getElementById('modal-overlay').classList.add('hidden'); };
        window.updateSearchQuery = (v) => { state.searchQuery = v; renderModal(); };
        window.editSeat = (act, p) => {
            const i = state.editingSeatIndex;
            if (act === 'SET_EMPTY') { state.seats[i] = null; state.lockedSeats[i] = false; state.seatAttributes[i] = 'EMPTY'; }
            else if (act === 'SET_ATTRIBUTE') { state.seatAttributes[i] = p; state.lockedSeats[i] = false; if (p) state.seats[i] = null; }
            else if (act === 'SET_STUDENT') {
                const prev = state.seats.indexOf(p); if (prev !== -1) { state.seats[prev] = null; state.lockedSeats[prev] = false; }
                state.seats[i] = p; state.lockedSeats[i] = true; state.seatAttributes[i] = null;
            }
            closeModal(); render();
        };

        // --- 保存処理 (安定版) ---
        window.prepareAndCapture = async (type) => {
            state.showSaveMenu = false; render();
            const el = document.getElementById('capture-container');
            if (!el) return;
            try {
                const canvas = await html2canvas(el, {
                    scale: 3, backgroundColor: '#ffffff', useCORS: true,
                    onclone: (cloned) => {
                        const target = cloned.getElementById('capture-container');
                        if (target) {
                            target.style.width = '1400px'; target.style.height = 'auto'; target.style.padding = '50px';
                            const grid = target.querySelector('.seat-grid');
                            if (grid) {
                                grid.style.display = 'grid';
                                grid.style.gridTemplateColumns = `repeat(${state.cols}, 120px)`;
                                grid.style.gridTemplateRows = `repeat(${state.rows}, 60px)`;
                                grid.style.gap = '10px';
                            }
                        }
                    }
                });
                if (type === 'png') {
                    canvas.toBlob(async (blob) => {
                        if (!blob) return;
                        const file = new File([blob], "座席表.png", { type: "image/png" });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            try { await navigator.share({ files: [file], title: '座席表' }); return; } catch (e) {}
                        }
                        const a = document.createElement('a'); a.download = "座席表.png"; a.href = canvas.toDataURL(); a.click();
                    });
                } else {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({ orientation: 'landscape' });
                    const pdfW = pdf.internal.pageSize.getWidth();
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfW - 20, 0);
                    pdf.save('座席表.pdf');
                }
            } catch (e) { alert("保存中にエラーが発生しました。"); }
        };

        function getStudent(id) { return state.students.find(s => s.id === id); }

        function renderBlackboard(pos) {
            const chalkPos = pos === 'top' ? 'bottom-1' : 'top-1';
            return `<div class="w-[70%] h-14 bg-[#1a472a] border-y-4 border-[#5d4037] shadow-xl relative my-4 flex items-center justify-center overflow-hidden rounded-sm flex-shrink-0"><div class="absolute ${chalkPos} right-4 w-8 h-1.5 bg-white/50 rounded-full rotate-1 shadow-sm"></div></div>`;
        }

        // --- 画面レンダリング ---
        function render() {
            const app = document.getElementById('app');
            if (state.mode === 'teacher') renderTeacher(app);
            else renderStudent(app);
            lucide.createIcons();
        }

        function renderTeacher(container) {
            const displayIndices = Array.from({ length: state.seats.length }, (_, i) => i);
            if (state.blackboardPosition === 'bottom') displayIndices.reverse();

            const sidebarWidth = state.isSidebarCollapsed ? 'w-16' : 'w-64';
            let cellsHtml = '';
            displayIndices.forEach(i => {
                const student = getStudent(state.seats[i]);
                const attr = state.seatAttributes[i];
                const isLocked = state.lockedSeats[i];
                const isSwapping = state.activeTool === 'SWAP' && state.swapSourceIndex === i;
                
                let bgColor = 'bg-gray-50', ring = isSwapping ? 'ring-4 ring-orange-400 z-10' : '';
                if (student) bgColor = student.gender === 'M' ? 'bg-blue-100' : 'bg-pink-100';
                else if (attr === 'EMPTY') bgColor = 'bg-gray-200';
                else if (attr === 'M') bgColor = 'bg-blue-50 border-dashed border-blue-300';
                else if (attr === 'F') bgColor = 'bg-pink-50 border-dashed border-pink-300';
                else if (isLocked) bgColor = 'bg-white border-red-200';

                let animStyle = state.isShuffling ? `transform: translate(${(Math.random()-0.5)*40}px, ${(Math.random()-0.5)*40}px) rotate(${(Math.random()-0.5)*20}deg);` : '';

                cellsHtml += `
                <div onclick="handleSeatClick(${i})" class="rounded border border-gray-300 flex flex-col items-center justify-center relative ${bgColor} ${ring} overflow-hidden" style="width: 120px; height: 60px; ${animStyle}">
                    ${student ? `<span class="text-[12px] font-bold text-gray-400 absolute top-0.5 left-1">${student.number}</span><div class="text-[13px] font-bold text-gray-800 line-clamp-2 text-center px-1">${student.name}</div>` : `<span class="text-gray-300 font-bold text-xs">${attr==='EMPTY'?'×':i+1}</span>`}
                    <div class="absolute top-0.5 right-1">${!student && isLocked ? '<i data-lucide="lock" class="w-2 h-2 text-red-400"></i>' : ''}</div>
                </div>`;
            });

            const gridHtml = `<div class="seat-grid grid gap-1 p-2 bg-white rounded-lg shadow-inner" style="grid-template-columns: repeat(${state.cols}, 120px); grid-template-rows: repeat(${state.rows}, 60px);">${cellsHtml}</div>`;

            container.innerHTML = `
                <header class="w-full h-14 bg-white border-b px-4 flex justify-between items-center shadow-sm shrink-0 z-30">
                    <h1 class="font-bold text-gray-700 text-lg">席替えくん</h1>
                    <button onclick="setMode('student')" class="bg-teal-600 text-white px-3 py-1.5 rounded font-bold text-xs flex items-center gap-1"><i data-lucide="monitor" class="w-4 h-4"></i> 生徒モード</button>
                </header>
                <div class="flex flex-1 overflow-hidden">
                    <aside class="${sidebarWidth} bg-white border-r h-full flex flex-col p-2 gap-3 transition-all duration-300 overflow-y-auto no-scrollbar print:hidden shrink-0">
                        <button onclick="toggleSidebar()" class="self-end text-gray-400 hover:text-gray-600"><i data-lucide="${state.isSidebarCollapsed?'chevron-right':'chevron-left'}"></i></button>
                        <button onclick="shuffleSeatsWithAnimation()" class="bg-indigo-600 text-white p-2 rounded font-bold text-xs flex items-center justify-center gap-2"><i data-lucide="shuffle" class="w-4 h-4"></i> ${state.isSidebarCollapsed?'':'席替え実行'}</button>
                        <button onclick="clearSeats()" class="bg-red-50 text-red-600 p-2 rounded font-bold text-xs border border-red-100 flex items-center justify-center gap-2"><i data-lucide="eraser" class="w-4 h-4"></i> ${state.isSidebarCollapsed?'':'クリア'}</button>
                        <div class="${state.isSidebarCollapsed?'hidden':''}">
                            <div class="flex gap-1">
                                <button onclick="window.print()" class="flex-1 bg-gray-100 p-2 rounded text-[10px] font-bold">印刷</button>
                                <div class="relative flex-1">
                                    <button onclick="toggleSaveMenu()" class="w-full bg-gray-100 p-2 rounded text-[10px] font-bold">保存</button>
                                    ${state.showSaveMenu ? `<div class="absolute top-full left-0 w-full bg-white border shadow-lg rounded z-50 py-1"><button onclick="prepareAndCapture('png')" class="w-full p-2 text-left hover:bg-gray-50 text-[10px]">画像</button><button onclick="prepareAndCapture('pdf')" class="w-full p-2 text-left hover:bg-gray-50 text-[10px]">PDF</button></div>` : ''}
                                </div>
                            </div>
                            <section class="bg-indigo-50 p-2 rounded border border-indigo-100 mt-4">
                                <h2 class="font-bold text-[10px] text-indigo-400 mb-2">一括設定</h2>
                                <div class="grid grid-cols-2 gap-1">
                                    <button onclick="setActiveTool('CURSOR')" class="p-1 rounded text-[10px] border ${state.activeTool==='CURSOR'?'bg-white shadow text-indigo-700':'text-indigo-400'}">選択</button>
                                    <button onclick="setActiveTool('EMPTY')" class="p-1 rounded text-[10px] border ${state.activeTool==='EMPTY'?'bg-gray-700 text-white':'text-indigo-400'}">空席</button>
                                    <button onclick="setActiveTool('M')" class="p-1 rounded text-[10px] border ${state.activeTool==='M'?'bg-blue-500 text-white':'text-indigo-400'}">♂ 男子</button>
                                    <button onclick="setActiveTool('F')" class="p-1 rounded text-[10px] border ${state.activeTool==='F'?'bg-pink-500 text-white':'text-indigo-400'}">♀ 女子</button>
                                </div>
                                <button onclick="setActiveTool('SWAP')" class="w-full mt-1 p-1 rounded text-[10px] border ${state.activeTool==='SWAP'?'bg-orange-500 text-white':'text-indigo-400'}">席の入れ替え</button>
                            </section>
                            <section class="border rounded p-2 text-[11px] mt-4">
                                <div class="flex justify-between items-center cursor-pointer" onclick="toggleRoster()"><span class="font-bold text-gray-500">名簿編集</span><i data-lucide="${state.isRosterOpen?'chevron-down':'chevron-right'}" class="w-3 h-3"></i></div>
                                ${state.isRosterOpen ? `<textarea oninput="updateImportText(this.value)" class="w-full h-32 mt-2 p-1 border rounded text-[10px] font-mono no-scrollbar">${state.importText}</textarea><button onclick="runImport()" class="w-full bg-gray-100 mt-1 py-1 rounded font-bold text-[10px]">更新</button>` : ''}
                            </section>
                            <div class="text-[11px] space-y-2 mt-4">
                                <div class="flex items-center justify-between">横幅 <div class="flex items-center gap-2"><button onclick="updateCols(${state.cols-1})" class="bg-gray-100 w-6 rounded">-</button><span>${state.cols}</span><button onclick="updateCols(${state.cols+1})" class="bg-gray-100 w-6 rounded">+</button></div></div>
                                <div class="flex items-center justify-between">縦幅 <div class="flex items-center gap-2"><button onclick="updateRows(${state.rows-1})" class="bg-gray-100 w-6 rounded">-</button><span>${state.rows}</span><button onclick="updateRows(${state.rows+1})" class="bg-gray-100 w-6 rounded">+</button></div></div>
                                <button onclick="toggleBlackboard()" class="w-full bg-white border py-1 rounded text-gray-500 mt-2 text-[10px]">黒板の上下を切り替え</button>
                            </div>
                        </div>
                    </aside>
                    <main class="flex-1 overflow-auto flex flex-col items-center p-4 bg-gray-100 pb-[120px]">
                        <div id="capture-container" class="flex flex-col items-center justify-center bg-gray-100 p-2 rounded-xl">
                            ${state.blackboardPosition === 'top' ? renderBlackboard('top') + gridHtml : gridHtml + renderBlackboard('bottom')}
                        </div>
                    </main>
                </div>
                ${state.showSaveMenu ? `<div class="fixed inset-0 z-40" onclick="toggleSaveMenu()"></div>` : ''}`;
        }

        function renderStudent(container) {
            const displayIndices = Array.from({ length: state.seats.length }, (_, i) => i);
            if (state.blackboardPosition === 'bottom') displayIndices.reverse();

            const controlsVisible = state.isStudentControlsVisible ? '' : 'hidden';
            const controls = `
                <div class="${controlsVisible} fixed bottom-4 left-0 right-0 flex justify-center items-center z-50">
                    <div class="bg-black/70 backdrop-blur-md p-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/20">
                        <button onclick="setMode('teacher')" class="px-4 py-2 bg-white/10 text-white rounded-xl font-bold text-sm">設定</button>
                        <button onclick="toggleBlackboard()" class="px-4 py-2 bg-white/10 text-white rounded-xl font-bold text-sm">黒板切替</button>
                        <button onclick="toggleSound()" class="p-2 bg-white/10 text-white rounded-full"><i data-lucide="${state.isSoundEnabled?'volume-2':'volume-x'}"></i></button>
                        <div class="w-px h-8 bg-white/20"></div>
                        <button onclick="shuffleSeatsWithAnimation()" ${state.isShuffling?'disabled':''} class="bg-indigo-500 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 text-sm"><i data-lucide="shuffle" class="w-4 h-4"></i> 席替え</button>
                        <button onclick="drumRollReveal()" ${state.isShuffling?'disabled':''} class="bg-yellow-500 text-black px-6 py-2 rounded-xl font-bold text-sm">公開</button>
                        <button onclick="revealAll()" ${state.isShuffling?'disabled':''} class="bg-green-500 text-white px-8 py-2 rounded-xl font-bold text-sm">一斉</button>
                        <button onclick="toggleControls(false)" class="p-2 bg-white/10 text-white rounded-full"><i data-lucide="x"></i></button>
                    </div>
                </div>
                ${!state.isStudentControlsVisible ? `<button onclick="toggleControls(true)" class="fixed bottom-6 right-6 bg-indigo-500 text-white p-4 rounded-full shadow-2xl z-50"><i data-lucide="chevron-up"></i></button>` : ''}`;

            let gridCells = '';
            displayIndices.forEach(i => {
                const student = getStudent(state.seats[i]);
                const isRev = state.revealState[i];
                if (!student && (state.seatAttributes[i] === 'EMPTY' || !state.seats[i])) {
                    gridCells += `<div class="rounded border border-white/5 bg-black/10 flex items-center justify-center opacity-30" style="width: 120px; height: 60px;">×</div>`;
                    return;
                }
                let anim = state.isShuffling ? `transform: translate(${(Math.random()-0.5)*400}px, ${(Math.random()-0.5)*400}px) rotate(${(Math.random()-0.5)*360}deg); opacity: 0.5;` : '';
                gridCells += `
                <div onclick="studentToggleCard(${i})" class="perspective-1000 cursor-pointer" style="width: 120px; height: 60px; ${anim}">
                    <div class="relative w-full h-full transform-style-3d transition-transform duration-500 ${isRev?'rotate-y-180':''}" style="transform: ${isRev?'rotateY(180deg)':'rotateY(0deg)'};">
                        <div class="absolute inset-0 backface-hidden bg-[#f3efe4] rounded-lg shadow-md border-b-4 border-r-4 border-gray-300 flex flex-col items-center justify-center text-gray-400">
                            <span class="text-[10px] font-bold">NO.</span><span class="text-xl font-bold">${student?.number || '-'}</span>
                        </div>
                        <div class="absolute inset-0 backface-hidden rotate-y-180 rounded-lg shadow-md border-b-4 border-r-4 ${student?.gender==='M'?'bg-blue-100':'bg-pink-100'} flex items-center justify-center text-gray-800" style="transform: rotateY(180deg); backface-visibility: hidden;">
                            ${student ? `<span class="absolute top-1 left-2 text-[10px] font-bold opacity-30">${student.number}</span><div class="text-[13px] font-bold text-center px-1">${student.name}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            });

            const gridHtml = `<div class="grid gap-2 p-4 justify-center content-center" style="grid-template-columns: repeat(${state.cols}, 120px); grid-template-rows: repeat(${state.rows}, 60px);">${gridCells}</div>`;

            container.innerHTML = `
                <div class="fixed inset-0 bg-[#2b3a42] flex flex-col items-center overflow-hidden font-sans p-4">
                    <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(circle, #ffffff 1px, transparent 1px); background-size: 24px 24px;"></div>
                    <div class="flex-1 w-full flex flex-col items-center justify-center z-10 overflow-auto no-scrollbar pb-[120px]">
                        ${state.blackboardPosition === 'top' ? renderBlackboard('top') + gridHtml : gridHtml + renderBlackboard('bottom')}
                    </div>
                    ${controls}
                </div>`;
        }

        function renderToolButton(tool, icon, label, activeClass, textIcon = '') {
            const active = state.activeTool === tool;
            return `<button onclick="setActiveTool('${tool}')" class="p-2 rounded flex flex-col items-center justify-center gap-1 w-full border ${active ? activeClass : 'bg-white text-gray-400 border-gray-200'} text-[10px]"><span>${textIcon}</span>${label}</button>`;
        }

        function renderModal() {
            const content = document.getElementById('modal-content');
            if (!content || state.editingSeatIndex === null) return;
            const i = state.editingSeatIndex;
            const placed = new Set(state.seats.filter(id => id !== null && id !== state.seats[i]));
            const filtered = state.students.filter(s => !placed.has(s.id) && (s.name || '').includes(state.searchQuery));
            let listHtml = filtered.map(s => `
                <button onclick="editSeat('SET_STUDENT', '${s.id}')" class="w-full p-3 text-left flex justify-between items-center hover:bg-indigo-50 border-b text-sm">
                    <div class="flex items-center gap-3"><span class="text-gray-400 w-6">${s.number}</span><span class="font-bold">${s.name}</span></div>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${s.gender==='M'?'bg-blue-100 text-blue-600':'bg-pink-100 text-pink-600'}">${s.gender==='M'?'男':'女'}</span>
                </button>`).join('');

            content.innerHTML = `
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center font-bold">座席 No.${i + 1} の設定<button onclick="closeModal()"><i data-lucide="x"></i></button></div>
                <div class="p-4 space-y-4 overflow-y-auto no-scrollbar">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="editSeat('SET_ATTRIBUTE', 'EMPTY')" class="p-3 border rounded-xl text-xs font-bold ${state.seatAttributes[i]==='EMPTY'?'bg-gray-800 text-white':'bg-white'}">空席にする</button>
                        <button onclick="editSeat('SET_ATTRIBUTE', null)" class="p-3 border rounded-xl text-xs font-bold ${!state.seatAttributes[i] && !state.lockedSeats[i]?'bg-indigo-600 text-white':'bg-white'}">指定なし</button>
                    </div>
                    <input type="text" placeholder="名前検索..." class="w-full p-3 border rounded-xl text-sm" value="${state.searchQuery}" oninput="updateSearchQuery(this.value)">
                    <div class="max-h-60 overflow-y-auto border rounded-xl divide-y no-scrollbar">${listHtml}</div>
                </div>`;
            lucide.createIcons();
        }

        window.onload = () => { parseStudents(INITIAL_STUDENTS_TEXT); initSeats(); };
    </script>
</body>
</html>
