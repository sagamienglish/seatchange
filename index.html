<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>席替えくん2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        #root { min-height: 100vh; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 20px;">iPad対応ツールを起動中...</p>
        </div>
    </div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // アイコン表示の不具合対策
        const Icon = ({ name, size = 18, className = "" }) => {
            const LucideIcon = window.lucide ? window.lucide[name] : null;
            return LucideIcon ? <LucideIcon size={size} className={className} /> : <span style={{width:size, height:size, display:'inline-block'}}></span>;
        };

        // --- 音声生成 (Web Audio API) ---
        const useSound = () => {
            const [audioCtx, setAudioCtx] = useState(null);
            const [enabled, setEnabled] = useState(true);
            useEffect(() => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) setAudioCtx(new AudioContext());
            }, []);
            const playTone = useCallback((freq, type, duration, startTime = 0, vol = 0.1) => {
                if (!audioCtx || !enabled) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
                gain.gain.setValueAtTime(0, audioCtx.currentTime + startTime);
                gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + startTime); osc.stop(audioCtx.currentTime + startTime + duration);
            }, [audioCtx, enabled]);

            return {
                playFlip: () => playTone(1000 + Math.random() * 200, 'sine', 0.1, 0, 0.08),
                playDrumroll: () => { if(audioCtx && enabled) for (let i = 0; i < 12; i++) playTone(150 + (i * 25), 'triangle', 0.1, i * 0.10, 0.15); },
                playTada: () => { if(audioCtx && enabled) [523.25, 659.25, 783.99, 987.77, 1174.66].forEach((f, i) => playTone(f, 'triangle', 1.8, i * 0.06, 0.15)); },
                enabled, setEnabled
            };
        };

        const INITIAL_STUDENTS = `1, 佐藤 健, 男\n2, 鈴木 愛, 女\n3, 高橋 翔, 男\n4, 田中 美咲, 女\n5, 伊藤 翼, 男\n6, 渡辺 結衣, 女\n7, 山本 蓮, 男\n8, 中村 陽菜, 女\n9, 小林 湊, 男\n10, 加藤 葵, 女`;

        function App() {
            const [mode, setMode] = useState('teacher');
            const [students, setStudents] = useState([]);
            const [rows, setRows] = useState(8);
            const [cols, setCols] = useState(6);
            const [seats, setSeats] = useState([]);
            const [revealState, setRevealState] = useState({});
            const [isShuffling, setIsShuffling] = useState(false);
            const { playFlip, playDrumroll, playTada, enabled: isSoundEnabled, setEnabled: setIsSoundEnabled } = useSound();

            useEffect(() => {
                const list = INITIAL_STUDENTS.trim().split('\n').map((line, i) => {
                    const p = line.split(/[,\t]/).map(s => s.trim());
                    return { id: `s-${i}`, number: p[0], name: p[1], gender: (p[2] && p[2].includes('女')) ? 'F' : 'M' };
                });
                setStudents(list);
                setSeats(new Array(rows * cols).fill(null).map((_, i) => list[i]?.id ?? null));
            }, []);

            const shuffle = () => {
                setIsShuffling(true); playDrumroll();
                setTimeout(() => {
                    setSeats(prev => [...prev].sort(() => Math.random() - 0.5));
                    setRevealState({}); setIsShuffling(false); playTada();
                }, 1500);
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white p-4 shadow-sm flex justify-between items-center z-10">
                        <h1 className="font-bold flex items-center gap-2 text-gray-700">
                            <Icon name="Settings" /> 座席替え
                        </h1>
                        <button onClick={() => setMode(mode==='teacher'?'student':'teacher')} className="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-transform">
                            {mode==='teacher' ? '生徒画面へ' : '設定へ戻る'}
                        </button>
                    </header>

                    <main className={`flex-1 p-4 flex flex-col items-center overflow-y-auto ${mode==='student' ? 'bg-[#2b3a42]' : 'bg-gray-100'}`}>
                        <div className="w-full max-w-4xl bg-[#1a472a] h-10 rounded border-b-8 border-[#5d4037] mb-8 flex items-center justify-center text-white/20 tracking-[1em] font-bold shadow-lg">BLACKBOARD</div>
                        
                        <div className="grid gap-2 w-full max-w-6xl pb-32" style={{ gridTemplateColumns: `repeat(${cols}, 1fr)` }}>
                            {seats.map((sid, i) => {
                                const s = students.find(x => x.id === sid);
                                const rev = revealState[i] || mode === 'teacher';
                                return (
                                    <div key={i} onClick={() => { if(!isShuffling) { playFlip(); setRevealState(p=>({...p, [i]:!p[i]})); } }} className="aspect-[4/3] relative" style={{ perspective: '1000px' }}>
                                        <div className={`w-full h-full transition-all duration-500 preserve-3d shadow-md rounded-md ${rev ? '' : 'bg-[#f0e6d2]'}`} style={{ transform: rev ? 'rotateY(180deg)' : 'rotateY(0deg)', transformStyle: 'preserve-3d' }}>
                                            <div className="absolute inset-0 flex items-center justify-center backface-hidden border border-dashed border-[#8d6e63]/20">
                                                <span className="text-2xl font-bold text-[#8d6e63] opacity-20">{s?.number}</span>
                                            </div>
                                            <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden rounded-md ${s?.gender==='M'?'bg-blue-100':'bg-pink-100'}`} style={{ transform: 'rotateY(180deg)' }}>
                                                <span className="text-[10px] text-gray-500 mb-1">{s?.number}</span>
                                                <span className="text-base font-bold text-gray-800">{s?.name}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {mode === 'student' && (
                            <div className="fixed bottom-8 flex gap-4 bg-black/50 p-4 rounded-full backdrop-blur-md shadow-2xl">
                                <button onClick={shuffle} disabled={isShuffling} className="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 active:scale-95 transition-transform"><Icon name="Shuffle" size={20}/>シャッフル</button>
                                <button onClick={() => { playTada(); const ns={}; seats.forEach((_,i)=>ns[i]=true); setRevealState(ns); }} className="bg-green-600 text-white px-6 py-3 rounded-full font-bold shadow-lg active:scale-95 transition-transform">一斉公開</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // 全てのライブラリが読み込まれるのを待ってから起動
        window.onload = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };
    </script>
</body>
</html>
