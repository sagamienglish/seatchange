<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>席替えくん26</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        #loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading-screen">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 20px; color: #4f46e5; font-weight: bold;">iPad対応システムを起動中...</p>
            <p style="font-size: 12px; color: #999;">30秒以上かかる場合はページを更新してください</p>
        </div>
    </div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <script type="text/babel">
        // ライブラリが完全に読み込まれるまで待機する仕組み
        const startApp = () => {
            const { useState, useEffect, useRef, useCallback } = React;

            // --- 先生の元の機能を完全再現 ---
            const useSound = () => {
                const [audioCtx, setAudioCtx] = useState(null);
                const [enabled, setEnabled] = useState(true);
                useEffect(() => {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) setAudioCtx(new AudioContext());
                }, []);
                const playTone = useCallback((freq, type, duration, startTime = 0, vol = 0.1) => {
                    if (!audioCtx || !enabled) return;
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
                    gain.gain.setValueAtTime(0, audioCtx.currentTime + startTime);
                    gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + startTime + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(audioCtx.currentTime + startTime); osc.stop(audioCtx.currentTime + startTime + duration);
                }, [audioCtx, enabled]);

                return {
                    playFlip: () => playTone(1000 + Math.random() * 200, 'sine', 0.1, 0, 0.08),
                    playDrumroll: () => { if(audioCtx && enabled) for (let i = 0; i < 12; i++) playTone(150 + (i * 25), 'triangle', 0.1, i * 0.10, 0.15); },
                    playTada: () => { if(audioCtx && enabled) [523.25, 659.25, 783.99, 987.77, 1174.66].forEach((f, i) => { playTone(f, 'triangle', 1.8, i * 0.06, 0.15); playTone(f * 2, 'sine', 1.2, i * 0.06, 0.05); }); },
                    enabled, setEnabled
                };
            };

            const Icon = ({ name, size = 18 }) => {
                const LucideIcon = window.lucide ? window.lucide[name] : null;
                return LucideIcon ? <LucideIcon size={size} /> : null;
            };

            const INITIAL_STUDENTS = `1, 佐藤 健, 男\n2, 鈴木 愛, 女\n3, 高橋 翔, 男\n4, 田中 美咲, 女\n5, 伊藤 翼, 男\n6, 渡辺 結衣, 女\n7, 山本 蓮, 男\n8, 中村 陽菜, 女\n9, 小林 湊, 男\n10, 加藤 葵, 女`;

            function SeatChangeApp() {
                const [mode, setMode] = useState('teacher');
                const [students, setStudents] = useState([]);
                const [rows, setRows] = useState(8);
                const [cols, setCols] = useState(6);
                const [seats, setSeats] = useState([]);
                const [lockedSeats, setLockedSeats] = useState({});
                const [seatAttributes, setSeatAttributes] = useState({});
                const [importText, setImportText] = useState(INITIAL_STUDENTS);
                const [revealState, setRevealState] = useState({});
                const [isShuffling, setIsShuffling] = useState(false);
                const [activeTool, setActiveTool] = useState('CURSOR');
                const { playFlip, playDrumroll, playTada, enabled: isSoundEnabled, setEnabled: setIsSoundEnabled } = useSound();

                useEffect(() => { parseStudents(INITIAL_STUDENTS); }, []);
                useEffect(() => {
                    const size = rows * cols;
                    setSeats(prev => {
                        const n = new Array(size).fill(null);
                        for (let i = 0; i < Math.min(prev.length, size); i++) n[i] = prev[i];
                        return n;
                    });
                }, [rows, cols]);

                const parseStudents = (text) => {
                    const lines = text.trim().split('\n');
                    const parsed = lines.map((line, i) => {
                        const p = line.split(/[,\t]/).map(s => s.trim());
                        return { id: `s-${i}`, number: p[0]||i+1, name: p[1]||`生徒${i+1}`, gender: (p[2] && p[2].includes('女')) ? 'F' : 'M' };
                    });
                    setStudents(parsed);
                };

                const shuffleLogic = () => {
                    let newSeats = [...seats];
                    const lockedIds = new Set();
                    seats.forEach((sid, i) => { if(lockedSeats[i] && sid) lockedIds.add(sid); else newSeats[i] = null; });
                    let pool = students.filter(s => !lockedIds.has(s.id));
                    let boys = pool.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
                    let girls = pool.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);
                    seats.forEach((_, i) => {
                        if(!newSeats[i]) {
                            if(seatAttributes[i] === 'M' && boys.length > 0) newSeats[i] = boys.pop().id;
                            else if(seatAttributes[i] === 'F' && girls.length > 0) newSeats[i] = girls.pop().id;
                        }
                    });
                    let remain = [...boys, ...girls].sort(() => Math.random() - 0.5);
                    seats.forEach((_, i) => { if(!newSeats[i] && seatAttributes[i] !== 'EMPTY' && remain.length > 0) newSeats[i] = remain.pop().id; });
                    setSeats(newSeats); setRevealState({});
                };

                const handleShuffle = () => {
                    if (mode === 'student') { setIsShuffling(true); playDrumroll(); setTimeout(() => { shuffleLogic(); setIsShuffling(false); playTada(); }, 1500); }
                    else shuffleLogic();
                };

                return (
                    <div className="min-h-screen flex flex-col font-sans">
                        <header className="bg-white p-3 border-b flex justify-between items-center shadow-sm z-50">
                            <h1 className="font-bold flex items-center gap-2 text-gray-700"><Icon name="Settings" /> 座席替えプロ</h1>
                            <div className="flex gap-2">
                                <button onClick={handleShuffle} className="bg-indigo-600 text-white px-4 py-1.5 rounded-lg font-bold shadow-md active:scale-95 flex items-center gap-1"><Icon name="Shuffle" size={16}/> 実行</button>
                                <button onClick={() => setMode(mode==='teacher'?'student':'teacher')} className="bg-teal-600 text-white px-4 py-1.5 rounded-lg font-bold shadow-md active:scale-95 flex items-center gap-1">
                                    {mode==='teacher' ? <><Icon name="Monitor" size={16}/>生徒画面</> : <><Icon name="Settings" size={16}/>設定へ</>}
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 flex overflow-hidden">
                            {mode === 'teacher' && (
                                <aside className="w-72 bg-white border-r p-4 overflow-y-auto space-y-6">
                                    <section>
                                        <h2 className="text-xs font-bold text-gray-400 uppercase mb-2">一括ペンツール</h2>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['CURSOR', 'EMPTY', 'M', 'F'].map(t => (
                                                <button key={t} onClick={() => setActiveTool(t)} className={`p-2 text-xs border rounded flex items-center justify-center gap-1 ${activeTool === t ? 'bg-indigo-600 text-white' : 'bg-white'}`}>
                                                    {t === 'CURSOR' ? <Icon name="MousePointer2" size={14}/> : t === 'EMPTY' ? <Icon name="UserX" size={14}/> : t}
                                                </button>
                                            ))}
                                        </div>
                                    </section>
                                    <section>
                                        <h2 className="text-xs font-bold text-gray-400 mb-2 uppercase">名簿更新</h2>
                                        <textarea className="w-full h-48 text-[10px] p-2 border font-mono bg-gray-50 rounded" value={importText} onChange={e => setImportText(e.target.value)} />
                                        <button onClick={() => parseStudents(importText)} className="w-full bg-gray-200 py-1.5 text-xs rounded mt-1 font-bold">反映</button>
                                    </section>
                                </aside>
                            )}

                            <main className={`flex-1 overflow-auto p-4 flex flex-col items-center ${mode==='student' ? 'bg-[#2b3a42]' : 'bg-gray-100'}`}>
                                <div className="w-full max-w-4xl bg-[#1a472a] h-12 border-y-4 border-[#5d4037] mb-6 flex items-center justify-center rounded shadow-xl text-white/20 tracking-[1em] text-xs font-bold">BLACKBOARD</div>
                                <div className="grid gap-3 w-full max-w-6xl pb-32" style={{ gridTemplateColumns: `repeat(${cols}, 1fr)` }}>
                                    {seats.map((sid, i) => {
                                        const s = students.find(x => x.id === sid);
                                        const rev = revealState[i] || mode === 'teacher';
                                        const attr = seatAttributes[i];
                                        let bg = s ? (s.gender==='M'?'bg-blue-100':'bg-pink-100') : 'bg-white';
                                        if (attr === 'EMPTY') bg = 'bg-gray-300';
                                        
                                        return (
                                            <div key={i} onClick={() => {
                                                if(mode==='teacher'){
                                                    if(activeTool==='CURSOR') setRevealState(p=>({...p, [i]:!p[i]}));
                                                    else if(activeTool==='EMPTY') setSeatAttributes(p=>({...p, [i]: p[i]==='EMPTY'?null:'EMPTY'}));
                                                    else setSeatAttributes(p=>({...p, [i]: p[i]===activeTool?null:activeTool}));
                                                } else if(!isShuffling) { playFlip(); setRevealState(p=>({...p, [i]:!p[i]})); }
                                            }} className="aspect-[4/3] perspective-1000 cursor-pointer">
                                                <div className={`w-full h-full relative preserve-3d transition-transform duration-500 ${rev?'rotate-y-180':''}`} style={{ transform: rev?'rotateY(180deg)':'none' }}>
                                                    <div className="absolute inset-0 flex items-center justify-center backface-hidden rounded bg-[#f0e6d2] border-2 border-dashed border-[#8d6e63]/20 shadow-sm">
                                                        <span className="text-3xl font-bold text-[#8d6e63] opacity-20">{s?.number}</span>
                                                    </div>
                                                    <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden rotate-y-180 rounded shadow-md ${bg}`} style={{ transform: 'rotateY(180deg)' }}>
                                                        {s && <><span className="text-[10px] text-gray-500 mb-1">{s.number}</span><span className="font-bold text-lg">{s.name}</span></>}
                                                        {!s && attr==='EMPTY' && <span className="text-gray-400 text-xs">空席</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                {mode === 'student' && (
                                    <div className="fixed bottom-10 flex gap-4 bg-black/40 p-5 rounded-full backdrop-blur-md shadow-2xl">
                                        <button onClick={() => setIsSoundEnabled(!isSoundEnabled)} className="text-white opacity-50 px-2"><Icon name={isSoundEnabled?"Volume2":"VolumeX"}/></button>
                                        <button onClick={handleShuffle} disabled={isShuffling} className="bg-indigo-600 text-white px-8 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-indigo-500"><Icon name="Shuffle" size={20}/>シャッフル開始</button>
                                        <button onClick={() => { playTada(); const ns={}; seats.forEach((_,i)=>ns[i]=true); setRevealState(ns); }} className="bg-green-600 text-white px-8 py-2 rounded-full font-bold shadow-lg hover:bg-green-500">一斉公開</button>
                                    </div>
                                )}
                            </main>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<SeatChangeApp />);
        };

        // ライブラリが全て揃うのを待ってから開始する安全装置
        const checkReady = () => {
            if (window.React && window.ReactDOM && window.lucide && window.Babel) {
                startApp();
            } else {
                setTimeout(checkReady, 100);
            }
        };
        checkReady();
    </script>
</body>
</html>
