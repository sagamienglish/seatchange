<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>席替えくん</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; background-color: #f3f4f6; }
        #root { min-height: 100vh; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .perspective-1000 { perspective: 1000px; }
        @media print {
          @page { size: landscape; margin: 5mm; }
          .print\:hidden { display: none !important; }
          .print\:bg-white { background-color: white !important; }
          body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="padding: 50px; text-align: center; font-family: sans-serif;">
            <h2>座席替えツールを起動中...</h2>
            <p>10秒以上かかる場合は再読み込みしてください。</p>
        </div>
    </div>

    <script type="text/babel">
        // Lucideアイコンの初期化待ち対策
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 先生の元のコードを完全に再現 ---
        const useSound = () => {
          const [audioCtx, setAudioCtx] = useState(null);
          const [enabled, setEnabled] = useState(true);
          useEffect(() => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) setAudioCtx(new AudioContext());
          }, []);
          const playTone = useCallback((freq, type, duration, startTime = 0, vol = 0.1) => {
            if (!audioCtx || !enabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime + startTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + startTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + startTime); osc.stop(audioCtx.currentTime + startTime + duration);
          }, [audioCtx, enabled]);

          return {
            playFlip: () => playTone(1000 + Math.random() * 200, 'sine', 0.1, 0, 0.08),
            playDrumroll: () => {
              if (!audioCtx || !enabled) return;
              for (let i = 0; i < 12; i++) playTone(150 + (i * 25), 'triangle', 0.1, i * 0.10, 0.15);
            },
            playTada: () => {
              if (!audioCtx || !enabled) return;
              [523.25, 659.25, 783.99, 987.77, 1174.66].forEach((f, i) => {
                playTone(f, 'triangle', 1.8, i * 0.06, 0.15);
                playTone(f * 2, 'sine', 1.2, i * 0.06, 0.05);
              });
            },
            enabled, setEnabled
          };
        };

        // --- アイコン読み込み用 ---
        const Icon = ({ name, ...props }) => {
          const LucideIcon = lucide[name] || lucide.User;
          return <LucideIcon {...props} />;
        };

        const INITIAL_STUDENTS_TEXT = `1, 佐藤 健, 男\n2, 鈴木 愛, 女\n3, 高橋 翔, 男\n4, 田中 美咲, 女\n5, 伊藤 翼, 男\n6, 渡辺 結衣, 女\n7, 山本 蓮, 男\n8, 中村 陽菜, 女\n9, 小林 湊, 男\n10, 加藤 葵, 女\n11, 吉田 樹, 男\n12, 山田 凛, 女\n13, 佐々木 陸, 男\n14, 山口 澪, 女\n15, 松本 蒼, 男\n16, 井上 紬, 女\n17, 木村 大和, 男\n18, 林 杏奈, 女\n19, 斎藤 悠真, 男\n20, 清水 桜, 女\n21, 山崎 瑛太, 男\n22, 池田 楓, 女\n23, 橋本 朝陽, 男\n24, 阿部 菫, 女\n25, 宮本 琉生, 男\n26, 石川 陽菜, 女\n27, 中川 湊斗, 男\n28, 野口 結菜, 女\n29, 酒井 大翔, 男\n30, 村上 莉子, 女\n31, 小川 悠人, 男\n32, 長谷川 咲良, 女\n33, 岡田 陽向, 男\n34, 藤田 結衣, 女\n35, 後藤 陸, 男\n36, 近藤 陽菜, 女\n37, 石井 湊, 男\n38, 小島 葵, 女\n39, 遠藤 樹, 男\n40, 青木 凛, 女\n41, 藤井 陸, 男\n42, 西村 澪, 女\n43, 安藤 蒼, 男\n44, 辻 紬, 女\n45, 山下 大和, 男\n46, 岡本 杏奈, 女\n47, 森本 悠真, 男\n48, 今井 桜, 女`;

        function App() {
          const [mode, setMode] = useState('teacher');
          const [students, setStudents] = useState([]);
          const [rows, setRows] = useState(8);
          const [cols, setCols] = useState(6);
          const [seats, setSeats] = useState([]);
          const [lockedSeats, setLockedSeats] = useState({});
          const [seatAttributes, setSeatAttributes] = useState({});
          const [importText, setImportText] = useState(INITIAL_STUDENTS_TEXT);
          const [revealState, setRevealState] = useState({});
          const [blackboardPosition, setBlackboardPosition] = useState('top');
          const [isShuffling, setIsShuffling] = useState(false);
          const [activeTool, setActiveTool] = useState('CURSOR');
          const [editingSeatIndex, setEditingSeatIndex] = useState(null);
          const [showSaveMenu, setShowSaveMenu] = useState(false);
          const captureRef = useRef(null);
          const { playFlip, playDrumroll, playTada, enabled: isSoundEnabled, setEnabled: setIsSoundEnabled } = useSound();

          useEffect(() => { parseStudents(INITIAL_STUDENTS_TEXT); }, []);
          useEffect(() => {
            const newSize = rows * cols;
            setSeats(prev => {
              const n = new Array(newSize).fill(null);
              for (let i = 0; i < Math.min(prev.length, newSize); i++) n[i] = prev[i];
              return n;
            });
          }, [rows, cols]);

          const parseStudents = (text) => {
            const lines = text.trim().split('\n');
            const parsed = lines.map((line, i) => {
              const parts = line.split(/[,\t]/).map(p => p.trim());
              return { id: `s-${i}`, number: parts[0]||i+1, name: parts[1]||`生徒${i+1}`, gender: (parts[2] && parts[2].includes('女')) ? 'F' : 'M' };
            });
            setStudents(parsed);
          };

          const shuffleLogic = () => {
            let newSeats = [...seats];
            const lockedIds = new Set();
            seats.forEach((sid, i) => { if(lockedSeats[i] && sid) lockedIds.add(sid); else newSeats[i] = null; });
            let pool = students.filter(s => !lockedIds.has(s.id));
            let boys = pool.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
            let girls = pool.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);
            
            seats.forEach((_, i) => {
              if(!newSeats[i]) {
                if(seatAttributes[i] === 'M' && boys.length > 0) newSeats[i] = boys.pop().id;
                else if(seatAttributes[i] === 'F' && girls.length > 0) newSeats[i] = girls.pop().id;
              }
            });
            let remain = [...boys, ...girls].sort(() => Math.random() - 0.5);
            seats.forEach((_, i) => { if(!newSeats[i] && seatAttributes[i] !== 'EMPTY' && remain.length > 0) newSeats[i] = remain.pop().id; });
            setSeats(newSeats); setRevealState({});
          };

          const handleShuffle = () => {
            if (mode === 'student') { setIsShuffling(true); playDrumroll(); setTimeout(() => { shuffleLogic(); setIsShuffling(false); playTada(); }, 1500); }
            else shuffleLogic();
          };

          const Blackboard = () => (
            <div className="w-full bg-[#1a472a] h-12 border-y-4 border-[#5d4037] mb-6 flex items-center justify-center rounded shadow-xl print:hidden">
              <div className="absolute right-10 w-8 h-1 bg-white/20 rounded-full"></div>
            </div>
          );

          return (
            <div className="min-h-screen bg-gray-100 no-scrollbar">
              <header className="bg-white p-3 border-b flex justify-between items-center shadow-sm print:hidden">
                <h1 className="font-bold flex items-center gap-2"><Icon name="Settings" /> 座席替えツール</h1>
                <div className="flex gap-2">
                  <button onClick={handleShuffle} className="bg-indigo-600 text-white px-4 py-1.5 rounded font-bold shadow flex items-center gap-1"><Icon name="Shuffle" size={16}/>実行</button>
                  <button onClick={() => setMode(mode==='teacher'?'student':'teacher')} className="bg-teal-600 text-white px-4 py-1.5 rounded font-bold shadow flex items-center gap-1">
                    {mode==='teacher' ? <><Icon name="Monitor" size={16}/>生徒画面</> : <><Icon name="Settings" size={16}/>設定へ</>}
                  </button>
                </div>
              </header>

              <div className="flex h-[calc(100vh-60px)]">
                {mode === 'teacher' && (
                  <aside className="w-72 bg-white border-r p-4 overflow-y-auto print:hidden space-y-6">
                    <div>
                      <h2 className="text-xs font-bold text-gray-400 uppercase mb-2">ペンツール</h2>
                      <div className="grid grid-cols-2 gap-2">
                        {['CURSOR', 'EMPTY', 'M', 'F'].map(t => (
                          <button key={t} onClick={() => setActiveTool(t)} className={`p-2 text-xs border rounded flex items-center justify-center gap-1 ${activeTool === t ? 'bg-indigo-600 text-white shadow-md' : 'bg-white hover:bg-gray-50'}`}>
                            {t === 'CURSOR' ? <Icon name="MousePointer2" size={14}/> : t === 'EMPTY' ? <Icon name="UserX" size={14}/> : t}
                          </button>
                        ))}
                      </div>
                    </div>
                    <div>
                      <h2 className="text-xs font-bold text-gray-400 mb-2">名簿編集</h2>
                      <textarea className="w-full h-48 text-[10px] p-2 border bg-gray-50 font-mono rounded" value={importText} onChange={e => setImportText(e.target.value)} />
                      <button onClick={() => parseStudents(importText)} className="w-full bg-gray-200 py-1.5 text-xs rounded mt-1 font-bold">名簿を反映</button>
                    </div>
                  </aside>
                )}

                <main className={`flex-1 overflow-auto p-6 flex flex-col items-center ${mode==='student' ? 'bg-[#2b3a42]' : 'bg-gray-100'}`}>
                  <div ref={captureRef} className="w-full max-w-5xl flex flex-col items-center">
                    {blackboardPosition === 'top' && <Blackboard />}
                    <div className="grid gap-3 w-full" style={{ gridTemplateColumns: `repeat(${cols}, 1fr)` }}>
                      {seats.map((sid, i) => {
                        const s = students.find(x => x.id === sid);
                        const rev = revealState[i] || mode === 'teacher';
                        const attr = seatAttributes[i];
                        let bg = s ? (s.gender==='M'?'bg-blue-100':'bg-pink-100') : 'bg-white';
                        if (attr === 'EMPTY') bg = 'bg-gray-300';
                        
                        return (
                          <div key={i} onClick={() => {
                            if(mode==='teacher'){
                                if(activeTool==='CURSOR') setEditingSeatIndex(i);
                                else if(activeTool==='EMPTY') setSeatAttributes(p=>({...p, [i]: p[i]==='EMPTY'?null:'EMPTY'}));
                                else setSeatAttributes(p=>({...p, [i]: p[i]===activeTool?null:activeTool}));
                            } else {
                                if(!isShuffling) { playFlip(); setRevealState(p=>({...p, [i]:!p[i]})); }
                            }
                          }} className={`aspect-[4/3] rounded-lg shadow border transition-all duration-500 perspective-1000 cursor-pointer ${mode==='student'?'':'hover:scale-105'}`}>
                            <div className={`w-full h-full relative preserve-3d transition-transform duration-500 ${rev?'rotate-y-180':''}`} style={{ transform: rev?'rotateY(180deg)':'none' }}>
                                <div className="absolute inset-0 flex items-center justify-center backface-hidden rounded-lg bg-[#f0e6d2] border-2 border-dashed border-[#8d6e63]/20">
                                    <span className="text-3xl font-bold text-[#8d6e63] opacity-20">{s?.number}</span>
                                </div>
                                <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden rotate-y-180 rounded-lg ${bg}`} style={{ transform: 'rotateY(180deg)' }}>
                                    {s && <><span className="text-[10px] text-gray-500 mb-1">{s.number}</span><span className="font-bold text-lg">{s.name}</span></>}
                                    {!s && attr==='EMPTY' && <span className="text-gray-500 text-xs">空席</span>}
                                    {lockedSeats[i] && <div className="absolute top-1 right-1"><Icon name="Lock" size={12} className="text-red-400"/></div>}
                                </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  {mode === 'student' && (
                    <div className="fixed bottom-10 flex gap-4 bg-black/40 p-5 rounded-full backdrop-blur-md shadow-2xl border border-white/10">
                        <button onClick={() => setIsSoundEnabled(!isSoundEnabled)} className="text-white opacity-70"><Icon name={isSoundEnabled?"Volume2":"VolumeX"}/></button>
                        <button onClick={handleShuffle} disabled={isShuffling} className="bg-indigo-600 text-white px-8 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-indigo-500 transition-colors"><Icon name="Shuffle" size={20}/>シャッフル開始</button>
                        <button onClick={() => { playTada(); const ns={}; seats.forEach((_,i)=>ns[i]=true); setRevealState(ns); }} className="bg-green-600 text-white px-8 py-2 rounded-full font-bold shadow-lg hover:bg-green-500 transition-colors">一斉公開</button>
                    </div>
                  )}
                </main>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
